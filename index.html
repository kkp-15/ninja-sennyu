<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å¿è€…æ½œå…¥ğŸ¯ â€” ãƒ¯ãƒ¼ãƒ«ãƒ‰å†…ã‚µã‚¤ã‚ºå›ºå®šãƒ»å®Œå…¨åˆ¶è¦‡ã§æœ€åˆã¸ãƒ»åŸå‰ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼å¼·åŒ–</title>
<style>
  :root{
    --bg:#070c18; --text:#eef3ff;
    --cell:44px; --gap:7px;
    --covered1:#1a2b52; --covered2:#132447; --covered-border:#3a5a94;
    --open1:#0f1b37; --open2:#0a1430; --open-border:#2c497b;
    --frontier:#46e1ff; --frontier-glow:#46e1ff55;
    --locked-stripe:#ffffff15;
    --start-outline:#8bd3ff; --trap-bg:#7a2a2a; --trap-border:#b33a3a;
    --ok:#b4ffb4; --ng:#ff9b9b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background: var(--bg);
    display:flex; flex-direction:column; align-items:center;
  }

  .bg{position:fixed; inset:-10vmax; z-index:-2; pointer-events:none;
    background:
      radial-gradient(1200px 800px at 10% -10%, #10306666, transparent 60%),
      radial-gradient(1300px 900px at 100% 10%, #2a1a6666, transparent 60%),
      linear-gradient(180deg,#0b1630,#070c18 55%,#060a12);
  }
  .bg::before{content:""; position:absolute; inset:0; opacity:.22;
    background-image:
      radial-gradient(#6fe1ff44 1px, transparent 1px),
      radial-gradient(#6fe1ff33 1px, transparent 1px);
    background-size:36px 36px,36px 36px; background-position:0 0,18px 18px;
    animation:gridMove 22s linear infinite;
  }
  @keyframes gridMove{from{transform:translateY(0)} to{transform:translateY(36px)}}

  .wrap{width:100%;max-width:980px;padding:14px 16px}
  header h1{margin:.2em 0 .1em}
  .sub{opacity:.85;margin:.2rem 0 .6rem}

  #boardWrap{
    width:100%; overflow:auto; -webkit-overflow-scrolling:touch;
    border-radius:16px; margin:.5rem 0;
    padding-left:max(12px, env(safe-area-inset-left));
    padding-right:max(6px, env(safe-area-inset-right));
  }
  #board{
    display:grid; gap:var(--gap);
    grid-template-columns:repeat(8,var(--cell)); /* JSã§æ›´æ–° */
    width:max-content; padding:14px;
    background:#0b1734; border:2px solid #233a64; border-radius:16px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05),0 16px 40px rgba(0,0,0,.55);
  }

  .cell{
    width:var(--cell); height:var(--cell); border-radius:12px; position:relative;
    display:flex; align-items:center; justify-content:center; user-select:none;
    font-weight:900; font-size:calc(var(--cell)*0.5);
    background:linear-gradient(180deg,var(--covered1),var(--covered2));
    border:2px solid var(--covered-border); color:#e9f1ff; cursor:pointer;
    transition:transform .06s ease, filter .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .cell:hover{filter:brightness(1.07)} .cell:active{transform:translateY(1px)}
  .cell.open{ background:linear-gradient(180deg,var(--open1),var(--open2)); border-color:var(--open-border); cursor:default; box-shadow:inset 0 3px 10px rgba(0,0,0,.45) }
  .cell.locked{
    cursor:not-allowed; opacity:.50;
    background:repeating-linear-gradient(135deg,var(--locked-stripe) 0 8px,transparent 8px 16px),linear-gradient(180deg,var(--covered1),var(--covered2));
  }
  .cell.frontier{
    box-shadow:0 0 0 3px var(--frontier) inset, 0 0 16px 2px var(--frontier-glow);
    border-color:#4bd3ff; filter:brightness(1.06);
    animation:pulse 1.2s ease-in-out infinite alternate;
  }
  @keyframes pulse{0%{box-shadow:0 0 0 2px var(--frontier) inset,0 0 10px 1px var(--frontier-glow)}100%{box-shadow:0 0 0 4px var(--frontier) inset,0 0 20px 3px var(--frontier-glow)}}
  .cell.start{ outline:2px dashed #8bd3ff; outline-offset:-2px }
  .cell.castle::after{ content:"ğŸ¯"; position:absolute; font-size:calc(var(--cell)*0.62) }
  .cell.trap{ background:linear-gradient(180deg,var(--trap-bg),#4f1111); border-color:var(--trap-border) }
  .safe0{ color:#c6d6f5; opacity:.95 }
  .n1{color:#76b7ff}.n2{color:#55d68c}.n3{color:#ffc14d}.n4{color:#c5a3ff}
  .n5{color:#ff9a6b}.n6{color:#8fe3ff}.n7{color:#ff7d92}.n8{color:#ffffff}
  .cell.ninja::before{content:"ğŸ¥·"; position:absolute; right:2px; bottom:2px; font-size:calc(var(--cell)*0.36)}

  .hud{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center; background:#0f1b37;border:1px solid #2a4272;border-radius:12px;padding:8px 10px;margin-bottom:.5rem}
  .pill{padding:.35em .7em;border-radius:999px;border:1px solid #37568f;background:#0f1b37;font-weight:800}
  #message{min-height:1.8em;text-align:center;font-weight:900}
  #message.win{color:var(--ok)} #message.lose{color:var(--ng)}
  .bar{display:flex;gap:12px;justify-content:center;margin:.35rem 0}
  .btn{ background:#16264a;border:2px solid #2a4272;color:#eaf1ff;border-radius:14px;font-weight:900;cursor:pointer;padding:12px 18px }
  .btn:hover{filter:brightness(1.08)}

  .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,.7)); z-index:10 }
  .overlay .panel{ background:#0f1b37; border:2px solid #2a4272; border-radius:18px; padding:18px; text-align:center; width:min(520px,92vw) }
  .overlay .panel .btn{ font-size:1rem; padding:10px 16px } /* ã‚¹ã‚¿ãƒ¼ãƒˆå°ã•ã‚ */
  .stage-badge{ width:var(--cell); height:var(--cell); display:inline-flex; align-items:center; justify-content:center; border-radius:12px; background:linear-gradient(180deg,var(--covered1),var(--covered2)); border:2px solid var(--covered-border); font-weight:900; font-size:calc(var(--cell)*0.34); color:#e9f1ff }
  .hidden{ display:none }

  .shake{ animation:shake .5s ease both }
  @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
  .boardShine{ position:relative }
  .boardShine::after{ content:""; position:absolute; inset:0; background:linear-gradient(120deg,transparent 0%, rgba(255,255,255,.08) 45%, transparent 55%); transform:translateX(-120%); animation:shine 1.2s ease-out forwards; border-radius:14px }
  @keyframes shine{to{ transform:translateX(120%) }}
  @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }

  footer{width:100%;max-width:980px;color:#cfe2ff99;padding:16px 16px 28px}
  footer .links{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  footer a{color:#8bd3ff; text-decoration:underline; font-weight:800}
</style>
</head>
<body>
  <div class="bg"></div>

  <header class="wrap">
    <h1>å¿è€…æ½œå…¥ğŸ¯</h1>
    <div class="hud">
      <span class="pill" id="stagePill">World 1-01</span>
      <span class="pill" id="sizePill">Size: 5Ã—5</span>
      <span class="pill" id="trapPill">ç½ : 6</span>
      <span class="pill">æ•°å­—ï¼ãã®ãƒã‚¹ã®<b>å‘¨å›²8æ–¹å‘</b>ã«ã‚ã‚‹ç½ ã®æ•°</span>
    </div>
    <p class="sub">å·¦ç«¯ã‹ã‚‰<strong>é †ç•ªã«</strong>ï¼ˆä¸Šä¸‹OKï¼å·¦éš£OKï¼æ–œã‚NGï¼‰ã€‚0ã§ã‚‚è‡ªå‹•é€£é–ãªã—ã€‚ã‚¿ãƒƒãƒ—ä½ç½®ã«ğŸ¥·è¡¨ç¤ºã€‚</p>
  </header>

  <main class="wrap">
    <div id="boardWrap"><div id="board" role="grid" aria-label="ã‚²ãƒ¼ãƒ ç›¤é¢"></div></div>
    <div class="bar"><button id="retry" class="btn" type="button">ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸</button></div>
    <p id="message" aria-live="polite"></p>
  </main>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
  <div id="intro" class="overlay" aria-modal="true" role="dialog">
    <div class="panel">
      <div style="display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:10px">
        <span style="opacity:.8">ã‚¹ãƒ†ãƒ¼ã‚¸</span>
        <span id="badge" class="stage-badge">1-01</span>
      </div>
      <button id="start" class="btn" type="button">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- æˆå¦ -->
  <div id="ov" class="overlay hidden" aria-modal="true" role="dialog">
    <div class="panel">
      <h2 id="ovTitle">ğŸ‰ æ½œå…¥æˆåŠŸï¼</h2>
      <p id="ovDesc">æœ¬ä¸¸ã«åˆ°é”ï¼</p>
      <div id="ovBtns" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="next" class="btn" type="button">â¤´ æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
        <button id="again" class="btn" type="button">ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸</button>
      </div>
    </div>
  </div>

  <footer class="wrap">
    <div class="links">
      <a href="https://x.com/kkp_webninja" target="_blank" rel="noopener">X @kkp_webninja</a>
      <span>ï¼</span>
      <a href="https://kkpwebninja.com" target="_blank" rel="noopener">ğŸ¯ kkpwebninja.com</a>
    </div>
  </footer>

<script>
(() => { 'use strict';
  const $ = (id)=>document.getElementById(id);
  const txt = (el, t)=>{ if(el) el.textContent = t; };
  const clamp=(a,b,v)=>Math.max(a, Math.min(b, v));
  const pad2=(n)=>String(n).padStart(2,'0');

  const boardEl = $('board'), wrapEl = $('boardWrap'), msgEl = $('message');
  const stagePill=$('stagePill'), sizePill=$('sizePill'), trapPill=$('trapPill');
  const intro = $('intro'), startBtn = $('start'), badge=$('badge');
  const ov = $('ov'), ovTitle=$('ovTitle'), ovDesc=$('ovDesc'), nextBtn=$('next'), againBtn=$('again'), retryBtn=$('retry'), ovBtns=$('ovBtns');
  if(!boardEl||!wrapEl||!msgEl||!stagePill||!sizePill||!trapPill||!intro||!startBtn||!badge||!ov||!ovTitle||!ovDesc||!nextBtn||!againBtn||!retryBtn){
    alert('åˆæœŸåŒ–å¤±æ•—ï¼šè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return;
  }

  // ===== è¨­å®šï¼šãƒ¯ãƒ¼ãƒ«ãƒ‰å†…ã¯ã‚µã‚¤ã‚ºå›ºå®šã€ã‚µãƒ–ã§ç½ å¢—åŠ  =====
  const MAX_WORLD=5, SUBS=5;
  let world=1, sub=1;
  let SIZE=5, TRAPS=6, board=[], revealed=[], ninja=null, castle={x:4,y:2};

  const sizeOfWorld = (w)=>({1:5,2:6,3:7,4:8,5:9}[w]||9);

  // ç½ ã¯ã‚µã‚¤ã‚ºåˆ¥ã®åŸºæº–ã‹ã‚‰é–‹å§‹ã—ã€ã‚µãƒ–ã”ã¨ã«+1ï¼ˆæœ€å¤§30%ã¾ã§ï¼‰
  function trapsOf(size, sub){
    const baseBySize = {5:6, 6:9, 7:12, 8:16, 9:20};
    const base = baseBySize[size] ?? Math.floor(size*size*0.22);
    const start = Math.max(1, base-1);           // 1é¢ç›®ã‚’å°‘ã—è»½ã‚ã«
    const cap = Math.floor(size*size*0.30);      // ã‚»ãƒ«ç·æ•°ã®30%ã‚’ä¸Šé™
    return Math.min(cap, start + (sub-1));       // ã‚µãƒ–ã”ã¨ã« +1
  }

  function setCellSize(size){
    const wrapW = wrapEl.clientWidth || window.innerWidth;
    const gap = 7*(size-1);
    const usable = Math.max(160, wrapW - 28 - gap - 8);
    const px = clamp(32,64, Math.floor(usable/size));
    document.documentElement.style.setProperty('--cell', px+'px');
  }
  window.addEventListener('resize', ()=> setCellSize(SIZE));

  function startNow(e){
    if(e){ e.preventDefault(); e.stopPropagation(); }
    if(intro.classList.contains('hidden')) return;
    intro.classList.add('hidden');
    startStage();
  }
  startBtn.addEventListener('click', startNow, {passive:false});
  startBtn.addEventListener('touchend', startNow, {passive:false});

  function startStage(){
    SIZE = sizeOfWorld(world);
    TRAPS = trapsOf(SIZE, sub);
    castle = {x: SIZE-1, y: Math.floor(SIZE/2)};
    setCellSize(SIZE);
    txt(stagePill, `World ${world}-${pad2(sub)}`);
    txt(sizePill,  `Size: ${SIZE}Ã—${SIZE}`);
    txt(trapPill,  `ç½ : ${TRAPS}`);
    txt(msgEl,''); ninja=null;

    board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
    revealed = Array.from({length:SIZE},()=>Array(SIZE).fill(false));

    // é€šè·¯ã‚’ç¢ºå®šï¼ˆæ–œã‚ãªã—ï¼‰
    const path = buildPath(SIZE, castle.y); path.add(`${castle.x},${castle.y}`);

    // ãƒ©ãƒ³ãƒ€ãƒ ç½ ï¼ˆé€šè·¯ãƒ»å·¦ç«¯ãƒ»ğŸ¯ã¯é™¤å¤–ï¼‰
    let placed=0, tries=0, maxTries=SIZE*SIZE*20;
    while(placed<TRAPS && tries++<maxTries){
      const x=Math.floor(Math.random()*SIZE), y=Math.floor(Math.random()*SIZE);
      if(x===0) continue;
      if(x===castle.x && y===castle.y) continue;
      if(path.has(`${x},${y}`)) continue;
      if(board[y][x]==='T') continue;
      board[y][x]='T'; placed++;
    }

    // ğŸ›¡ åŸå‰ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼å¼·åŒ–ï¼šåŸã®å·¦ãƒã‚¹ã®éš£æ¥ã«æœ€ä½1ç½ 
    enforceCastlePressure(path);

    // æ•°å­—è¨ˆç®—
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      if(board[y][x]==='T') continue;
      board[y][x]=count8(x,y);
    }

    draw();
  }

  function buildPath(size, cy){
    let y = Math.floor(Math.random()*size);
    const s = new Set();
    for(let x=0;x<=size-1;x++){
      s.add(`${x},${y}`);
      if(x<size-1){
        if(y<cy && Math.random()<0.5){ y++; s.add(`${x},${y}`); }
        else if(y>cy && Math.random()<0.5){ y--; s.add(`${x},${y}`); }
      }
    }
    while(y<cy){ y++; s.add(`${size-1},${y}`); }
    while(y>cy){ y--; s.add(`${size-1},${y}`); }
    return s;
  }

  function count8(x,y){
    let c=0;
    for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
      if(dx===0&&dy===0) continue;
      const nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
      if(board[ny][nx]==='T') c++;
    }
    return c;
  }

  // ğŸ›¡ åŸå‰ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ï¼šåŸã®å·¦ãƒã‚¹(LC)ã®å‘¨å›²8ã«æœ€ä½1ç½ ã‚’â€œä»–æ‰€ã®ç½ ã‚’ç§»å‹•â€ã—ã¦ç¢ºä¿ï¼ˆé€šè·¯ãƒ»å·¦ç«¯ãƒ»ğŸ¯ã¯é¿ã‘ã‚‹ï¼‰
  function enforceCastlePressure(path){
    const lcx = castle.x-1, lcy = castle.y;
    if(lcx<0) return;

    const countT = (x,y)=>{
      let c=0;
      for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
        if(!dx&&!dy) continue;
        const nx=x+dx, ny=y+dy;
        if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
        if(board[ny][nx]==='T') c++;
      }
      return c;
    };

    if(countT(lcx,lcy) >= 1) return; // æ—¢ã«åœ§ã‚ã‚Š

    // ç½ ã‚’ç½®ã‘ã‚‹å€™è£œï¼ˆLCã®8è¿‘å‚ï¼‰
    const nearCandidates=[];
    for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
      if(!dx&&!dy) continue;
      const nx=lcx+dx, ny=lcy+dy;
      if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
      if(nx===castle.x && ny===castle.y) continue; // ğŸ¯
      if(nx===0) continue;                         // å·¦ç«¯ç¦æ­¢
      if(path.has(`${nx},${ny}`)) continue;        // é€šè·¯ã‚’å£Šã•ãªã„
      if(board[ny][nx]==='T') { /* æ—¢ã«ç½ ãªã‚‰OK */ return; }
      nearCandidates.push({nx,ny});
    }

    if(nearCandidates.length===0) return; // ç½®ã‘ã‚‹å ´æ‰€ãŒãªã„

    // â€œç§»å‹•å…ƒâ€ã®ç½ ï¼ˆé ã‚ã§é€šè·¯ã§ã‚‚åŸå‰è¿‘å‚ã§ã‚‚ãªã„ã‚‚ã®ï¼‰
    const donors=[];
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      if(board[y][x]!=='T') continue;
      if(path.has(`${x},${y}`)) continue;          // é€šè·¯ã®ç½ ã¯å­˜åœ¨ã—ãªã„ã¯ãšã ã‘ã©ä¿é™º
      if(x===0) continue;                           // å·¦ç«¯ç¦æ­¢
      const manh = Math.abs(x-(lcx))+Math.abs(y-(lcy));
      if(manh>2) donors.push({x,y});
    }
    // ãƒ‰ãƒŠãƒ¼ãŒç„¡ã‘ã‚Œã°ã€è¿‘å‚ä»¥å¤–ã®ä»»æ„ã®ç½ ã‹ã‚‰ã§ã‚‚ç§»å‹•
    if(donors.length===0){
      for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
        if(board[y][x]==='T' && !path.has(`${x},${y}`) && x!==0) donors.push({x,y});
      }
    }
    if(donors.length===0) return; // ã©ã†ã—ã¦ã‚‚ç§»ã›ãªã„å ´åˆã¯è«¦ã‚ï¼ˆç¨€ï¼‰

    // å®Ÿéš›ã«â€œç§»å‹•â€
    const target = nearCandidates[Math.floor(Math.random()*nearCandidates.length)];
    const donor  = donors[Math.floor(Math.random()*donors.length)];
    board[donor.y][donor.x]=0;
    board[target.ny][target.nx]='T';
  }

  // å·¦ã‹ã‚‰é †ï¼šå·¦ç«¯OKã€åŒåˆ—ä¸Šä¸‹OKã€å·¦éš£OKã€æ–œã‚NG
  const canOpen=(x,y)=>{
    if(revealed[y][x]) return false;
    if(x===0) return true;
    if(y>0 && revealed[y-1][x]) return true;
    if(y<SIZE-1 && revealed[y+1][x]) return true;
    if(x>0 && revealed[y][x-1]) return true;
    return false;
  };

  function draw(){
    boardEl.style.gridTemplateColumns = `repeat(${SIZE}, var(--cell))`;
    boardEl.innerHTML='';
    boardEl.classList.remove('boardShine');
    for(let y=0;y<SIZE;y++){
      for(let x=0;x<SIZE;x++){
        const el=document.createElement('button');
        el.type='button'; el.className='cell'; el.setAttribute('aria-label',`è¡Œ${y+1} åˆ—${x+1}`);
        if(x===0) el.classList.add('start');
        if(x===SIZE-1 && y===Math.floor(SIZE/2)) el.classList.add('castle');

        const allow = canOpen(x,y);
        if(!revealed[y][x]) el.classList.add(allow?'frontier':'locked');
        else{
          el.classList.add('open');
          if(board[y][x]==='T'){ el.classList.add('trap'); el.textContent='ğŸ’¥'; }
          else{
            const n=board[y][x];
            if(n===0) el.classList.add('safe0'); else { el.textContent=n; el.classList.add('n'+n); }
          }
        }
        if(ninja && ninja.x===x && ninja.y===y) el.classList.add('ninja');

        el.addEventListener('click', ()=>onOpen(x,y));
        el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onOpen(x,y); } });
        boardEl.appendChild(el);
      }
    }
  }

  function onOpen(x,y){
    if(!canOpen(x,y)){ txt(msgEl,'å·¦ç«¯â†’åˆ°é”æ¸ˆã¿ã®ä¸Šä¸‹å·¦å³ã ã‘é–‹ã‘ã‚‰ã‚Œã¾ã™ã€‚'); return; }
    if(revealed[y][x]) return;
    revealed[y][x]=true; ninja={x,y};

    if(board[y][x]==='T'){
      txt(msgEl,'ğŸ’¥ ç½ ã«ã‹ã‹ã£ãŸï¼');
      wrapEl.classList.add('shake'); setTimeout(()=>wrapEl.classList.remove('shake'),600);
      revealAll(); draw(); showLose(); return;
    }
    draw();
    if(x===SIZE-1 && y===Math.floor(SIZE/2)){
      txt(msgEl,'ğŸ‰ æ½œå…¥æˆåŠŸï¼');
      boardEl.classList.add('boardShine'); confettiFX();
      revealAll(); draw(); showWin();
    }
  }

  const revealAll=()=>{ for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++) revealed[y][x]=true; };

  function confettiFX(){
    const EMO=['ğŸ‰','âœ¨','ğŸ’','ğŸ¥·','ğŸ‘‘']; const n=46;
    const lay=document.createElement('div');
    Object.assign(lay.style,{position:'fixed',left:0,top:'-10vh',width:'100%',height:'110vh',pointerEvents:'none',zIndex:11});
    document.body.appendChild(lay);
    for(let i=0;i<n;i++){
      const s=document.createElement('span');
      s.textContent=EMO[i%EMO.length];
      Object.assign(s.style,{position:'absolute',left:Math.random()*100+'%',top:'-10vh',fontSize:(22+Math.random()*10)+'px',animation:`fall ${1.8+Math.random()*1.8}s linear forwards`});
      lay.appendChild(s);
    }
    setTimeout(()=>lay.remove(),2600);
  }

  // === ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===
  function showWin(){
    const isFinal = (world===MAX_WORLD && sub===SUBS);
    if(isFinal){
      txt(ovTitle,'ğŸ… å®Œå…¨åˆ¶è¦‡ï¼');
      txt(ovDesc,'å…¨25é¢ã‚¯ãƒªã‚¢ï¼æœ€åˆã®çŠ¶æ…‹ï¼ˆ1-1ï¼‰ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚');
      // ã€Œæ¬¡ã¸ã€ã¯éš ã—ã€ã€Œæœ€åˆã‹ã‚‰ã€ã«æ–‡è¨€å¤‰æ›´
      nextBtn.classList.add('hidden');
      againBtn.textContent = 'ğŸ” æœ€åˆã‹ã‚‰';
    }else{
      txt(ovTitle,'ğŸ‰ æ½œå…¥æˆåŠŸï¼');
      txt(ovDesc,'æœ¬ä¸¸ã«åˆ°é”ï¼æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸é€²ã‚ã¾ã™ã€‚');
      nextBtn.classList.remove('hidden');
      againBtn.textContent = 'ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸';
    }
    ov.classList.remove('hidden');
  }
  function showLose(){
    txt(ovTitle,'ğŸ’¥ ä»»å‹™å¤±æ•—â€¦'); txt(ovDesc,'ç½ ã«ã‹ã‹ã£ãŸï¼åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸ã§å†æŒ‘æˆ¦ã€‚');
    nextBtn.classList.add('hidden');
    againBtn.textContent = 'ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸';
    ov.classList.remove('hidden');
  }
  function hideOv(){ ov.classList.add('hidden'); nextBtn.classList.remove('hidden'); }

  nextBtn.addEventListener('click', ()=>{
    hideOv();
    if(sub<SUBS){ sub++; }
    else { sub=1; world=Math.min(MAX_WORLD, world+1); }
    showIntro();
  });
  againBtn.addEventListener('click', ()=>{
    const isFinal = (world===MAX_WORLD && sub===SUBS);
    hideOv();
    if(isFinal){ world=1; sub=1; } // â† å®Œå…¨åˆ¶è¦‡å¾Œã¯æœ€åˆã®çŠ¶æ…‹ã¸
    showIntro(true);
  });
  retryBtn.addEventListener('click', ()=>{ hideOv(); showIntro(true); });

  function showIntro(same=false){
    const s = sizeOfWorld(world);
    txt(badge, `${world}-${pad2(sub)}`);
    txt(stagePill, `World ${world}-${pad2(sub)}`);
    txt(sizePill,  `Size: ${s}Ã—${s}`);
    txt(trapPill,  `ç½ : ${trapsOf(s, sub)}`);
    intro.classList.remove('hidden');
  }

  // åˆæœŸè¡¨ç¤º
  showIntro();
})();
</script>
</body>
</html>
