<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å¿è€…æ½œå…¥ã®è¡“ ğŸ—¡ï¸ğŸ¯</title>

<!-- âœ… SEO -->
<meta name="description" content="ç½ ã‚’èª­ã¿è§£ãã€æœ¬ä¸¸ã¸æ½œå…¥ã›ã‚ˆã€‚ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼é¢¨ã®åˆ°é”å‹ãƒ‘ã‚ºãƒ«ã€å¿è€…æ½œå…¥ã®è¡“ã€ã€‚æ—¥æ›¿ã‚ã‚Šä»»å‹™ãƒ»é›£æ˜“åº¦åˆ‡æ›¿ãƒ»Xã‚·ã‚§ã‚¢å¯¾å¿œã€‚" />
<meta name="keywords" content="ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼, å¿è€…, ãƒ‘ã‚ºãƒ«, è«–ç†, ç„¡æ–™, ã‚¹ãƒãƒ›, åˆ°é”å‹, Webã‚¢ãƒ—ãƒª" />

<!-- âœ… OGP / Xï¼ˆ1200x630 ã‚’æ¨å¥¨ï¼‰ -->
<meta property="og:title" content="å¿è€…æ½œå…¥ã®è¡“" />
<meta property="og:description" content="ç½ ã‚’èª­ã¿è§£ãã€æœ¬ä¸¸ã¸æ½œå…¥ã›ã‚ˆã€‚æ—¥æ›¿ã‚ã‚Šä»»å‹™ã‚ã‚Šï¼" />
<meta property="og:image" content="card.png" />
<meta property="og:url" content="https://example.com/" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />

<!-- âœ… Faviconï¼ˆä»»æ„ï¼‰ -->
<link rel="icon" href="favicon.ico" />

<!-- âœ… Google Analyticsï¼ˆã„ã¤ã‚‚ã®è¨ˆæ¸¬IDï¼‰ -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2LM85GJN0L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-2LM85GJN0L');
</script>

<style>
  :root{
    --bg:#0b0f1a;         /* å¤œè‰² */
    --panel:#121828;
    --accent:#8bd3ff;     /* å¿å…‰ */
    --safe:#1b2337;
    --tile:#161e31;
    --tile-hover:#1c2540;
    --flag:#ffb84d;
    --trap:#ff5d5d;
    --text:#e7eefc;
    --muted:#9fb2d0;
    --ok:#64e291;
    --warn:#ffcc66;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#09101f 0%, #0b0f1a 100%);
    color:var(--text); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    display:flex; flex-direction:column; align-items:center;
  }
  header{
    width:100%; max-width:980px; padding:16px 16px 0; text-align:center;
  }
  h1{margin:4px 0 8px; font-size:1.6rem; letter-spacing:.04em}
  .sub{color:var(--muted); font-size:.9rem}
  .bar{
    width:100%; max-width:980px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:12px 16px;
  }
  select,button{
    background:var(--panel); color:var(--text); border:1px solid #22304b; border-radius:12px;
    padding:10px 14px; font-size:.95rem; box-shadow:0 2px 8px rgba(0,0,0,.35);
    transition:transform .02s ease, background .2s ease, border-color .2s ease;
  }
  button:hover{ background:#182038 }
  button:active{ transform:translateY(1px) }
  .badge{
    padding:8px 12px; border-radius:12px; background:#0f1840; color:var(--accent); border:1px solid #203060; min-width:84px; text-align:center
  }
  #boardWrap{
    width:100%; max-width:980px; flex:1; display:flex; align-items:center; justify-content:center; padding:8px 16px 16px;
  }
  #board{
    display:grid; gap:6px; touch-action:manipulation; background:#0c1326; padding:10px; border-radius:18px; border:1px solid #1d2a45;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03), 0 12px 36px rgba(0,0,0,.45);
  }
  .cell{
    width:40px; height:40px; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#151d33,#0f1730); border:1px solid #22304b; border-radius:10px; user-select:none;
    font-weight:700; line-height:1; position:relative;
  }
  .cell.covered:hover{ background:var(--tile-hover); cursor:pointer }
  .cell.open{
    background:linear-gradient(180deg,#1a2340,#121c39); border-color:#2a3c5d;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
  }
  .cell.flag::after{
    content:"âš‘"; position:absolute; font-size:20px; color:var(--flag); transform:translateY(-1px);
    text-shadow:0 0 8px rgba(255,184,77,.35);
  }
  .cell.goal::after{ content:"ğŸ¯"; position:absolute; font-size:22px; transform:translateY(-1px) }
  .cell.start::after{ content:"â›©ï¸"; position:absolute; font-size:20px; transform:translateY(-1px) }
  .n0{color:#99a8c7} .n1{color:#7fc3ff} .n2{color:#ffb86b} .n3{color:#b99cff}
  .n4{color:#8bd3ff} .n5{color:#ffd166} .n6{color:#64e291} .n7{color:#ff8b8b} .n8{color:#e7eefc}
  .lost{ animation:lostFlash .15s 3 }
  @keyframes lostFlash{ 0%{filter:none} 50%{filter:hue-rotate(-20deg) brightness(1.4)} 100%{filter:none} }
  footer{ width:100%; max-width:980px; padding:16px; text-align:center; color:var(--muted) }
  #footer{
    border-top:1px solid #23324f; margin-top:12px; padding-top:12px; font-size:.95rem;
  }
  a{ color:var(--accent); text-decoration:none }
  a:hover{ text-decoration:underline }
  .topRow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; margin-top:6px }
  .spacer{ flex:1 1 auto }
  .ghost{ opacity:.7 }
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼šç›¤ã®ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚’ç¸®ã‚ã‚‹ */
  @media (max-width:420px){
    .cell{ width:34px; height:34px; border-radius:9px; }
    #board{ gap:5px }
  }
</style>
</head>
<body>

<header>
  <h1>å¿è€…æ½œå…¥ã®è¡“ ğŸ—¡ï¸ğŸ¯</h1>
  <div class="sub">ç½ ã‚’èª­ã¿è§£ãã€å·¦ç«¯ã®é–€ã‹ã‚‰å³ç«¯ã®æœ¬ä¸¸ã¸æ½œå…¥ã›ã‚ˆã€‚</div>

  <div class="bar">
    <label>é›£æ˜“åº¦ï¼š
      <select id="difficulty">
        <option value="easy">ç”ºï¼ˆ9Ã—9ï¼‰</option>
        <option value="normal" selected>åŸé–€ï¼ˆ12Ã—12ï¼‰</option>
        <option value="hard">æœ¬ä¸¸ï¼ˆ16Ã—16ï¼‰</option>
      </select>
    </label>
    <button id="newGameBtn">æ–°ã—ã„ä»»å‹™</button>
    <button id="dailyBtn">æ—¥æ›¿ã‚ã‚Šä»»å‹™</button>
    <div class="badge" id="timer">00:00</div>
    <div class="badge" id="flags">æ—— 0</div>
    <div class="badge" id="score">å¾—ç‚¹ 0</div>
    <button id="shareBtn">Xã§å…±æœ‰</button>
  </div>
</header>

<div id="boardWrap">
  <div id="board" aria-label="ã‚²ãƒ¼ãƒ ç›¤é¢" role="grid"></div>
</div>

<footer>
  <div class="sub ghost">æ“ä½œï¼šã‚¿ãƒƒãƒ—=é–‹ãï½œé•·æŠ¼ã—=æ——ï½œæ•°å­—ã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—=åˆå›³é–‹ã‘</div>
  <div id="footer">
    X <a href="https://x.com/kkp_webninja" target="_blank">@kkp_webninja</a> <br>
    ğŸ¯ <a href="https://kkpwebninja.com" target="_blank">webå¿è€…ã®æœ¬ä¸¸</a><br>
  </div>
</footer>

<script>
/* ===============================
   å¿è€…æ½œå…¥ã®è¡“ - åˆ°é”å‹ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼ï¼ˆMVPï¼‰
   ã„ã¤ã‚‚ã®æ„Ÿã˜ï¼š
   - 1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµ / GitHub Pageså¯
   - SEO/OGP/Analytics/ãƒ•ãƒƒã‚¿ãƒ¼
   - ã‚³ãƒ¡ãƒ³ãƒˆå¤šã‚ãƒ»æ‹¡å¼µå®¹æ˜“
================================== */

/* ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆPRNG / ã‚·ãƒ¼ãƒ‰ï¼‰ ---------- */
function mulberry32(a){ return function(){ var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function strToSeed(str){
  let h=2166136261>>>0;
  for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
  return h>>>0;
}
function pad(n){return n.toString().padStart(2,'0')}

/* ---------- è¨­å®š ---------- */
const DIFFS = {
  easy:   {w:9,h:9, density:0.12},
  normal: {w:12,h:12,density:0.15},
  hard:   {w:16,h:16,density:0.18}
};
const STATE = {
  board:null, rng:Math.random, running:false, startTs:0, timerId:null,
  flagsLeft:0, opened:0, lost:false, won:false, seed:'', diff:'normal',
  start:{x:0,y:0}, goal:{x:0,y:0}, score:0
};

/* ---------- ç›¤é¢ç”Ÿæˆï¼šå®‰å…¨ãƒ‘ã‚¹â†’ç½ é…ç½® ---------- */
function newBoard(diffKey, seedStr){
  const diff = DIFFS[diffKey];
  const seed = seedStr || (Date.now().toString(36));
  STATE.rng = mulberry32(strToSeed(seed));
  STATE.seed = seed; STATE.diff = diffKey; STATE.lost=false; STATE.won=false; STATE.score=0;

  // åŸºæœ¬é…åˆ—
  const W=diff.w, H=diff.h;
  const cells = Array.from({length:H},(_,y)=>Array.from({length:W},(_,x)=>({
    x,y,isTrap:false, number:0, state:'covered'
  })));

  // ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆå·¦ç«¯ã®ãƒ©ãƒ³ãƒ€ãƒ è¡Œï¼‰ã€ã‚´ãƒ¼ãƒ«ï¼ˆå³ç«¯ã®ãƒ©ãƒ³ãƒ€ãƒ è¡Œï¼‰
  const startY = Math.floor(STATE.rng()*H);
  const goalY  = Math.floor(STATE.rng()*H);
  STATE.start={x:0,y:startY}; STATE.goal={x:W-1,y:goalY};

  // 1) å®‰å…¨ãƒ‘ã‚¹ã‚’å½«ã‚‹ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆâ†’ã‚´ãƒ¼ãƒ«ã¸è›‡è¡Œæ°—å‘³ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯ï¼‰
  carveSafePath(cells, W,H, STATE.start, STATE.goal);

  // 2) æ®‹ã‚Šã«ç½ ã‚’é…ç½®ï¼ˆå¯†åº¦ï¼‰
  const targetTraps = Math.floor(W*H*diff.density);
  placeTraps(cells, targetTraps);

  // 3) æ•°å­—ã‚’è¨ˆç®—
  computeNumbers(cells, W,H);

  // 4) åˆ°é”ä¿è¨¼ï¼ˆå®‰å…¨ãƒã‚¹ã®ã¿ã§åˆ°é”ã§ãã‚‹ã‹ä¸€å¿œç¢ºèªï¼‰
  if(!reachableSafe(cells, W,H, STATE.start, STATE.goal)){
    // åˆ°é”ã§ããªã‘ã‚Œã°åˆ¥seedã§å†ç”Ÿæˆ
    return newBoard(diffKey, seedStr ? seedStr+'a' : null);
  }
  return {W,H,cells};
}

function neighbors8(x,y,W,H){
  const out=[];
  for(let dy=-1; dy<=1; dy++){
    for(let dx=-1; dx<=1; dx++){
      if(dx===0 && dy===0) continue;
      const nx=x+dx, ny=y+dy;
      if(nx>=0 && nx<W && ny>=0 && ny<H) out.push({x:nx,y:ny});
    }
  }
  return out;
}
function carveSafePath(cells,W,H,start,goal){
  // ç›´é€²ãƒã‚¤ã‚¢ã‚¹ä»˜ããƒ©ãƒ³ãƒ€ãƒ ã‚¦ã‚©ãƒ¼ã‚¯ã§å³ç«¯ã¸ä¼¸ã°ã™ã€‚æˆ»ã‚Šã¯æ§ãˆã‚ã€‚
  let x=start.x, y=start.y;
  cells[y][x].safePath = true;
  const maxSteps = W*H*3;
  let steps=0;
  while((x!==goal.x || y!==goal.y) && steps<maxSteps){
    steps++;
    const moves=[];
    // å³ã¸ã®ãƒã‚¤ã‚¢ã‚¹ï¼ˆã‚´ãƒ¼ãƒ«ã¯å³ç«¯ï¼‰
    if(x<goal.x) moves.push({dx:1,dy:0,w:0.48});
    // ä¸Šä¸‹ã¸è»½ãè›‡è¡Œ
    if(y>goal.y) moves.push({dx:0,dy:-1,w:0.23});
    if(y<goal.y) moves.push({dx:0,dy:1,w:0.23});
    // ç¨€ã«æ–œã‚
    moves.push({dx:1,dy:(STATE.rng()<0.5?-1:1),w:0.06});

    const r = STATE.rng();
    let acc=0, chosen={dx:1,dy:0};
    for(const m of moves){ acc+=m.w; if(r<=acc){ chosen=m; break; }

    }
    const nx = Math.max(0, Math.min(W-1, x+chosen.dx));
    const ny = Math.max(0, Math.min(H-1, y+chosen.dy));
    x=nx; y=ny;
    cells[y][x].safePath=true;
  }
  // å¿µã®ãŸã‚ã€ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚´ãƒ¼ãƒ«ã‚‚ãƒãƒ¼ã‚­ãƒ³ã‚°
  cells[start.y][start.x].safePath=true;
  cells[goal.y][goal.x].safePath=true;
}
function placeTraps(cells, targetTraps){
  const H=cells.length, W=cells[0].length;
  let placed=0, guard=0, maxGuard=W*H*4;
  while(placed<targetTraps && guard++<maxGuard){
    const x=Math.floor(STATE.rng()*W), y=Math.floor(STATE.rng()*H);
    const c=cells[y][x];
    if(c.safePath || c.isTrap) continue;
    c.isTrap=true; placed++;
  }
}
function computeNumbers(cells,W,H){
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=cells[y][x];
      if(c.isTrap){ c.number=-1; continue; }
      let n=0;
      for(const nb of neighbors8(x,y,W,H)){ if(cells[nb.y][nb.x].isTrap) n++; }
      c.number=n;
    }
  }
}
function reachableSafe(cells,W,H,start,goal){
  const q=[start]; const seen=new Set([start.x+','+start.y]);
  while(q.length){
    const p=q.shift();
    if(p.x===goal.x && p.y===goal.y) return true;
    for(const nb of neighbors8(p.x,p.y,W,H)){
      const key=nb.x+','+nb.y;
      const c=cells[nb.y][nb.x];
      if(c.isTrap) continue;
      if(!seen.has(key)){ seen.add(key); q.push(nb); }
    }
  }
  return false;
}

/* ---------- æç”»ãƒ»ã‚²ãƒ¼ãƒ ç®¡ç† ---------- */
const elBoard = document.getElementById('board');
const elTimer = document.getElementById('timer');
const elFlags = document.getElementById('flags');
const elScore = document.getElementById('score');
const elDiff  = document.getElementById('difficulty');

document.getElementById('newGameBtn').addEventListener('click', ()=>startNew());
document.getElementById('dailyBtn').addEventListener('click', ()=>startDaily());
document.getElementById('shareBtn').addEventListener('click', shareToX);
elDiff.addEventListener('change', ()=>startNew());

function startNew(){
  const diff = elDiff.value;
  const b = newBoard(diff, null);
  mountBoard(b);
  startTimer();
  updateFlagsUI();
  updateScore(0);
  // URLã‚’è»½ãæ›´æ–°ï¼ˆseed/dï¼‰
  const url = new URL(location.href);
  url.searchParams.set('d', diff);
  url.searchParams.set('seed', STATE.seed);
  history.replaceState(null,'',url.toString());
  gtag('event','start_game',{diff});
}
function startDaily(){
  const diff = elDiff.value;
  const today = new Date();
  const seed = today.getFullYear()+pad(today.getMonth()+1)+pad(today.getDate()); // YYYYMMDD
  const b = newBoard(diff, seed);
  mountBoard(b);
  startTimer();
  updateFlagsUI();
  updateScore(0);
  const url = new URL(location.href);
  url.searchParams.set('d', diff);
  url.searchParams.set('seed', seed);
  url.searchParams.set('mission','1');
  history.replaceState(null,'',url.toString());
  gtag('event','daily_mission',{diff,seed});
}

function mountBoard({W,H,cells}){
  STATE.board={W,H,cells};
  // æ——æ•°ç›®å®‰ï¼ç½ æ•°æ¨å®šï¼ˆæ•°å­—è¨ˆç®—å¾Œã«æ•°ãˆç›´ã—ã¦ã‚‚OKï¼‰
  const traps = cells.flat().filter(c=>c.isTrap).length;
  STATE.flagsLeft = traps;
  STATE.opened = 0; STATE.running=false; STATE.lost=false; STATE.won=false;

  elBoard.style.gridTemplateColumns = `repeat(${W}, 1fr)`;
  elBoard.innerHTML='';
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=cells[y][x];
      const div=document.createElement('div');
      div.className='cell covered';
      div.setAttribute('role','gridcell');
      div.dataset.x=x; div.dataset.y=y;

      // ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚´ãƒ¼ãƒ«è¡¨ç¤ºï¼ˆè¦†ã‚ã‚Œã¦ã„ã¦ã‚‚ã‚¢ã‚¤ã‚³ãƒ³ã§é›°å›²æ°—ï¼‰
      if(x===STATE.start.x && y===STATE.start.y) div.classList.add('start');
      if(x===STATE.goal.x && y===STATE.goal.y) div.classList.add('goal');

      attachCellHandlers(div);
      elBoard.appendChild(div);
    }
  }
}

function updateFlagsUI(){ elFlags.textContent = `æ—— ${STATE.flagsLeft}`; }
function startTimer(){
  clearInterval(STATE.timerId);
  STATE.startTs = Date.now(); STATE.running=true;
  STATE.timerId=setInterval(()=>{
    if(!STATE.running) return;
    const s = Math.floor((Date.now()-STATE.startTs)/1000);
    elTimer.textContent = `${pad(Math.floor(s/60))}:${pad(s%60)}`;
  }, 200);
}
function stopTimer(){ STATE.running=false; clearInterval(STATE.timerId); }

function openCell(x,y, viaChord=false){
  if(STATE.lost||STATE.won) return;
  const c = STATE.board.cells[y][x];
  const el = getCellEl(x,y);
  if(c.state==='open') return;

  // æ——ä¸­ã¯é–‹ã‘ãªã„
  if(c.state==='flag') return;

  // åˆå›æ“ä½œï¼ˆå¿µã®ãŸã‚ï¼šé–‹å§‹æ‰±ã„ï¼‰
  if(!STATE.running){ startTimer(); }

  c.state='open';
  el.classList.remove('covered','flag'); el.classList.add('open');

  if(c.isTrap){
    // ç½ ï¼šæ•—åŒ—
    el.textContent='âœ–';
    el.style.color='var(--trap)';
    lose(x,y);
    return;
  }
  STATE.opened++;
  // æ•°å­—æç”»
  if(c.number>0){
    el.textContent = c.number;
    el.classList.add('n'+c.number);
  }else{
    el.textContent = ''; // n0
    // 0ã¯å‘¨å›²ã‚’è‡ªå‹•å±•é–‹ï¼ˆãƒ•ãƒ©ãƒƒãƒ‰ï¼‰
    floodOpenZeros(x,y);
  }
  // åˆå›³é–‹ã‘ã‹ã‚‰ã®å±•é–‹ã®ã¨ãã¯ã€ã‚¹ã‚³ã‚¢æ§ãˆã‚
  updateScore(STATE.score + (viaChord? 4 : (c.number===0? 8:6)));

  // ç›®æ¨™ï¼šã‚´ãƒ¼ãƒ«ã‚’é–‹ã‘ã€ã‹ã¤é“ãŒå®‰å…¨ãªã‚‰å‹åˆ©ï¼ˆåˆ°é”å‹ï¼‰
  if(x===STATE.goal.x && y===STATE.goal.y){
    win();
  }
}

function floodOpenZeros(sx,sy){
  const {W,H,cells} = STATE.board;
  const q=[{x:sx,y:sy}], seen=new Set([sx+','+sy]);
  while(q.length){
    const p=q.shift();
    for(const nb of neighbors8(p.x,p.y,W,H)){
      const key=nb.x+','+nb.y;
      if(seen.has(key)) continue;
      const c=cells[nb.y][nb.x];
      if(c.state!=='open' && !c.isTrap){
        c.state='open';
        const el=getCellEl(nb.x,nb.y);
        el.classList.remove('covered','flag'); el.classList.add('open');
        if(c.number>0){ el.textContent=c.number; el.classList.add('n'+c.number); }
        else{ el.textContent=''; q.push(nb); }
        STATE.opened++;
      }
      seen.add(key);
    }
  }
}

function toggleFlag(x,y){
  if(STATE.lost||STATE.won) return;
  const c=STATE.board.cells[y][x];
  if(c.state==='open') return;
  const el=getCellEl(x,y);
  if(c.state==='flag'){
    c.state='covered'; el.classList.remove('flag'); STATE.flagsLeft++;
    updateScore(STATE.score - 1);
  }else{
    c.state='flag'; el.classList.add('flag'); STATE.flagsLeft--;
    updateScore(STATE.score + 1);
  }
  updateFlagsUI();
}

function chordOpen(x,y){
  const c=STATE.board.cells[y][x];
  if(c.state!=='open' || c.number<=0) return;
  const {W,H,cells}=STATE.board;
  const around = neighbors8(x,y,W,H);
  const flags = around.filter(p=>cells[p.y][p.x].state==='flag').length;
  if(flags!==c.number) return;
  for(const nb of around){
    const nc=cells[nb.y][nb.x];
    if(nc.state==='covered') openCell(nb.x,nb.y,true);
  }
}

function lose(x,y){
  STATE.lost=true; stopTimer();
  revealAll(true, x,y);
  elBoard.classList.add('lost');
  setTimeout(()=>elBoard.classList.remove('lost'), 500);
  gtag('event','lose',{diff:STATE.diff,seed:STATE.seed});
}
function win(){
  STATE.won=true; stopTimer();
  // ã‚¹ã‚³ã‚¢ä»•ä¸Šã’ï¼ˆæ™‚é–“ãƒ»ãƒ«ãƒ¼ãƒˆè£œæ­£ï¼‰
  const sec = Math.floor((Date.now()-STATE.startTs)/1000);
  const timeBonus = Math.max(0, 300 - sec)*2;
  updateScore(STATE.score + 1000 + timeBonus);

  // ã•ã•ã‚„ã‹ãªæ¼”å‡ºï¼šç›¤é¢ã®ã‚´ãƒ¼ãƒ«ã«æ——
  const goalEl = getCellEl(STATE.goal.x, STATE.goal.y);
  goalEl.textContent='ğŸ³ï¸â€ğŸŒ™';

  gtag('event','win',{diff:STATE.diff,seed:STATE.seed,sec,score:STATE.score});
  alert(`æ½œå…¥æˆåŠŸï¼ æœ¬ä¸¸åˆ°é”\næ™‚é–“ ${sec}s / ã‚¹ã‚³ã‚¢ ${STATE.score}`);
}

function revealAll(showTraps=false, hitX=-1,hitY=-1){
  const {W,H,cells}=STATE.board;
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=cells[y][x];
      const el=getCellEl(x,y);
      if(showTraps && c.isTrap){
        el.textContent='â€»'; el.style.color='var(--trap)'; el.classList.add('open');
      }else if(c.state!=='open'){
        // ãã®ã¾ã¾
      }
      if(x===hitX && y===hitY){ el.style.outline='2px solid var(--trap)'; }
    }
  }
}

function getCellEl(x,y){
  return elBoard.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
}

/* ---------- ã‚»ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ãƒƒãƒ—/é•·æŠ¼ã—/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ï¼‰ ---------- */
function attachCellHandlers(el){
  let pressTimer=null, longPressed=false, lastTap=0;

  function onDown(e){
    e.preventDefault();
    longPressed=false;
    pressTimer = setTimeout(()=>{
      longPressed=true;
      const x=+el.dataset.x, y=+el.dataset.y;
      toggleFlag(x,y);
      navigator.vibrate && navigator.vibrate(10);
    }, 420); // é•·æŠ¼ã—åˆ¤å®š
  }
  function onUp(e){
    e.preventDefault();
    clearTimeout(pressTimer);
    const now=Date.now(), delta=now-lastTap; lastTap=now;
    const x=+el.dataset.x, y=+el.dataset.y;
    if(longPressed) return; // æ——æ“ä½œæ¸ˆã¿
    if(delta<250){
      // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ï¼åˆå›³é–‹ã‘
      chordOpen(x,y);
    }else{
      openCell(x,y);
    }
  }

  el.addEventListener('touchstart', onDown, {passive:false});
  el.addEventListener('touchend', onUp, {passive:false});
  el.addEventListener('mousedown', onDown);
  el.addEventListener('mouseup', onUp);

  // å³ã‚¯ãƒªãƒƒã‚¯ã§æ——ï¼ˆPCï¼‰
  el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); toggleFlag(+el.dataset.x,+el.dataset.y); });
}

/* ---------- ã‚¹ã‚³ã‚¢/UI ---------- */
function updateScore(v){ STATE.score=Math.max(0,Math.floor(v)); elScore.textContent=`å¾—ç‚¹ ${STATE.score}`; }

/* ---------- èµ·å‹•æ™‚ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å†ç¾ ---------- */
(function init(){
  const url=new URL(location.href);
  const d = url.searchParams.get('d') || 'normal';
  const seed = url.searchParams.get('seed');
  elDiff.value = DIFFS[d]? d : 'normal';
  const b = newBoard(elDiff.value, seed);
  mountBoard(b);
  startTimer();
  updateFlagsUI();
  updateScore(0);
})();

/* ---------- å…±æœ‰ï¼ˆX/Twitterï¼‰ ---------- */
function shareToX(){
  const url=new URL(location.href);
  url.searchParams.set('d', STATE.diff);
  url.searchParams.set('seed', STATE.seed);
  const sec = Math.floor((Date.now()-STATE.startTs)/1000);
  const text =
`å¿è€…æ½œå…¥ã®è¡“
æœ¬ä¸¸ã¾ã§${sec}ç§’ / ã‚¹ã‚³ã‚¢${STATE.score}
#å¿è€…æ½œå…¥ #webå¿è€…ã®æœ¬ä¸¸
${url.toString()}

@kkp_webninja`;
  const link = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
  window.open(link,'_blank');
}
</script>
</body>
</html>
