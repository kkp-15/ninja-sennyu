<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å¿è€…æ½œå…¥ã®è¡“ ğŸ¯ï¼ˆ8Ã—8ãƒ»å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</title>
<style>
  :root{
    --bg:#0a0f1c; --panel:#111a2e; --text:#eef3ff; --muted:#a8b7d3;
    --cell:48px; --accent:#8bd3ff; --danger:#ff6b6b; --ok:#c7f0c7;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#091327,#0a0f1c); color:var(--text);
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    display:flex; flex-direction:column;
  }
  .wrap{ width:100%; max-width:860px; margin:0 auto; padding:12px 16px; }
  h1{ margin:.4rem 0 .2rem; letter-spacing:.03em }
  .sub{ margin:0 0 .6rem; color:var(--muted) }

  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .btn{
    background:#16264a; border:2px solid #2a4272; color:#eaf1ff; padding:10px 14px; border-radius:12px;
    font-weight:700; cursor:pointer; box-shadow:0 3px 10px rgba(0,0,0,.35);
  }
  .btn:hover{ filter:brightness(1.08) }
  .btn.ghost{ background:transparent }

  details{ margin-left:auto }
  details>summary{ cursor:pointer; padding:8px 10px; border-radius:10px; border:1px solid #29406c; }
  details label{ display:block; margin-top:8px; color:#cfe0ff }
  #trapCountVal{ display:inline-block; width:2rem; text-align:right; margin-left:4px }

  #board{
    display:grid; grid-template-columns:repeat(8, var(--cell)); gap:6px;
    background:#0b1734; border:2px solid #233a64; padding:12px; border-radius:16px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 14px 38px rgba(0,0,0,.45);
    touch-action:manipulation;
  }
  .cell{
    width:var(--cell); height:var(--cell); border-radius:10px;
    display:flex; align-items:center; justify-content:center; user-select:none;
    font-weight:900; font-size:calc(var(--cell)*0.52); line-height:1;
    background:linear-gradient(180deg,#16264a,#132650); border:2px solid #3b5a93; color:#e9f1ff;
    transition:filter .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
    cursor:pointer; position:relative;
  }
  .cell:hover{ filter:brightness(1.06) }
  .cell.open{
    background:linear-gradient(180deg,#0f1a33,#0a1430); border-color:#2e4677; cursor:default;
    box-shadow:inset 0 2px 8px rgba(0,0,0,.45);
  }
  .cell.start{ outline:2px dashed rgba(139,211,255,.45); outline-offset:-2px }
  .cell.castle::after{ content:"ğŸ¯"; position:absolute; font-size:calc(var(--cell)*0.6) }
  .cell.trap{ background:#5a1a1a; border-color:#8a2a2a; color:#fff }
  .cell.safe0{ color:#b7c7e6 }
  .num1{color:#74b6ff}.num2{color:#6fe8a1}.num3{color:#ffd166}.num4{color:#c3a1ff}
  .num5{color:#ffb354}.num6{color:#89ddff}.num7{color:#ff9090}.num8{color:#ffffff}

  .badge{ padding:8px 10px; border:1px solid #29406c; border-radius:10px; color:#d8e7ff; min-width:110px; text-align:center }
  .message{ min-height:1.6em; margin:.6rem 0; font-weight:700 }
  .muted{ color:var(--muted) }

  @media (max-width:420px){ :root{ --cell:42px } }
  @media (prefers-reduced-motion:reduce){ *{ transition:none !important; animation:none !important } }
</style>
</head>
<body>
  <header class="wrap">
    <h1>å¿è€…æ½œå…¥ã®è¡“ ğŸ¯</h1>
    <p class="sub">å·¦ç«¯ã‹ã‚‰ğŸ¯ã¾ã§<strong>ä¸Šä¸‹å·¦å³ã ã‘</strong>ã§é“ã‚’ã¤ãªã’ã‚ï¼ˆæ–œã‚ç§»å‹•ãªã—ï¼‰</p>

    <div class="toolbar">
      <button id="newBtn" class="btn">æ–°ã—ã„ä»»å‹™</button>
      <button id="dailyBtn" class="btn">æ—¥æ›¿ã‚ã‚Šä»»å‹™</button>
      <span id="status" class="badge" aria-live="polite"></span>

      <details>
        <summary>è¨­å®š</summary>
        <label>
          ãƒ’ãƒ³ãƒˆï¼ˆæ•°å­—ã®æ•°ãˆæ–¹ï¼‰ï¼š
          <select id="hintMode">
            <option value="8">8æ–¹å‘ï¼ˆæ¿ƒã„ãƒ’ãƒ³ãƒˆï¼‰</option>
            <option value="4">4æ–¹å‘ï¼ˆè–„ã„ãƒ’ãƒ³ãƒˆï¼‰</option>
          </select>
        </label>
        <label>
          ç½ ã®æ•°ï¼š
          <input id="trapCount" type="range" min="8" max="18" step="1" value="10" />
          <span id="trapCountVal">10</span>
        </label>
        <label>
          é–‹å¹•ã§å·¦ç«¯ã®ä¸­å¤®ã‚’è‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³
          <input id="autoOpen" type="checkbox" checked />
        </label>
      </details>
    </div>
  </header>

  <main class="wrap">
    <div id="board" role="grid" aria-label="ã‚²ãƒ¼ãƒ ç›¤é¢ 8Ã—8"></div>
    <p id="message" class="message" aria-live="polite"></p>
  </main>

  <footer class="wrap">
    <button id="retryBtn" class="btn ghost">ã‚‚ã†ä¸€åº¦</button>
    <span class="muted">ãƒ’ãƒ³ãƒˆã¯è¨­å®šã‹ã‚‰4/8æ–¹å‘ã‚’åˆ‡æ›¿ã§ãã¾ã™ã€‚</span>
  </footer>

<script>
/* ========== å¿è€…æ½œå…¥ 8x8 / å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆ ========== */
const SIZE = 8;
let TRAPS = 10;
let HINT_MODE = localStorage.getItem("hintMode") || "8"; // "8" or "4"
let AUTO_OPEN = (localStorage.getItem("autoOpen") ?? "1") === "1";

const boardEl = document.getElementById("board");
const msgEl = document.getElementById("message");
const statusEl = document.getElementById("status");
const trapCountEl = document.getElementById("trapCount");
const trapCountValEl = document.getElementById("trapCountVal");
const hintModeEl = document.getElementById("hintMode");
const autoOpenEl = document.getElementById("autoOpen");

hintModeEl.value = HINT_MODE;
autoOpenEl.checked = AUTO_OPEN;
trapCountValEl.textContent = trapCountEl.value;
TRAPS = +trapCountEl.value;

trapCountEl.addEventListener("input", () => {
  TRAPS = +trapCountEl.value;
  trapCountValEl.textContent = TRAPS;
});
hintModeEl.addEventListener("change", () => {
  HINT_MODE = hintModeEl.value;
  localStorage.setItem("hintMode", HINT_MODE);
  status("ãƒ’ãƒ³ãƒˆ: " + (HINT_MODE==="8"?"8æ–¹å‘":"4æ–¹å‘"));
});
autoOpenEl.addEventListener("change", () => {
  AUTO_OPEN = autoOpenEl.checked;
  localStorage.setItem("autoOpen", AUTO_OPEN ? "1" : "0");
});

document.getElementById("newBtn").addEventListener("click", () => startNew());
document.getElementById("dailyBtn").addEventListener("click", () => startDaily());
document.getElementById("retryBtn").addEventListener("click", () => startNew());

/* ---- ä¹±æ•°ï¼†ã‚·ãƒ¼ãƒ‰ ---- */
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function strToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
function todaySeed(){
  const d = new Date(); const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), day=("0"+d.getDate()).slice(-2);
  return `${y}${m}${day}`;
}

/* ---- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---- */
let rng, state;

function startNew(seed=null){
  const useSeed = seed || Math.random().toString(36).slice(2);
  rng = mulberry32(strToSeed(useSeed));
  initGame();
  status("ä»»å‹™é–‹å§‹");
}
function startDaily(){
  const seed = todaySeed();
  rng = mulberry32(strToSeed(seed));
  initGame();
  status("æ—¥æ›¿ã‚ã‚Šä»»å‹™ " + seed);
}

function initGame(){
  msg(""); // clear
  const castlePos = { x: SIZE-1, y: Math.floor(SIZE/2) };
  const startRow  = Math.floor(SIZE/2);

  // ç›¤é¢åˆæœŸåŒ–
  const board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  const revealed = Array.from({length:SIZE},()=>Array(SIZE).fill(false));
  const trapSet = new Set();

  // å·¦â†’å³ã®å®‰å…¨ãƒ«ãƒ¼ãƒˆã‚’1æœ¬ä½œã‚‹ï¼ˆ4æ–¹å‘ã§é€²ã‚€ï¼‰
  const path = generatePath(startRow, castlePos);

  // ç½ é…ç½®ï¼šãƒ«ãƒ¼ãƒˆä¸Šã¨å·¦ç«¯ã€ğŸ¯ã¯é™¤å¤–
  let placed = 0;
  while (placed < TRAPS) {
    const x = Math.floor(rng()*SIZE);
    const y = Math.floor(rng()*SIZE);
    if (x===0) continue;
    if (x===castlePos.x && y===castlePos.y) continue;
    if (path.some(p=>p.x===x && p.y===y)) continue;
    const key = y*SIZE+x;
    if (trapSet.has(key)) continue;
    trapSet.add(key);
    board[y][x] = "B";
    placed++;
  }

  // æ•°å­—è¨ˆç®—ï¼ˆ4/8æ–¹å‘ã¯è¨­å®šã§ï¼‰
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      if (board[y][x]==="B") continue;
      board[y][x] = countAround(x,y,board, HINT_MODE==="8");
    }
  }

  // é–‹å¹•ï¼šå·¦ç«¯ä¸­å¤®ã‚’è‡ªå‹•ã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆè¨­å®šONæ™‚ï¼‰
  if (AUTO_OPEN) openCell(startRow, 0, board, revealed, castlePos);

  render(board, revealed, castlePos);
  state = { board, revealed, castlePos };
}

function generatePath(startRow, castlePos){
  const path = [];
  let x=0, y=startRow;
  path.push({x,y});
  const maxStep = SIZE*SIZE*4; let step=0;
  while ((x!==castlePos.x || y!==castlePos.y) && step++<maxStep){
    const moves=[];
    if (x<castlePos.x) moves.push({dx:1,dy:0,w:0.65}); // å³ã‚’å¼·ã‚
    if (y>castlePos.y) moves.push({dx:0,dy:-1,w:0.175});
    if (y<castlePos.y) moves.push({dx:0,dy:1,w:0.175});
    // å°‘ã—ä¸Šä¸‹ã«æ•£ã‚‰ã™
    if (rng()<0.25 && y>0) moves.push({dx:0,dy:-1,w:0.05});
    if (rng()<0.25 && y<SIZE-1) moves.push({dx:0,dy:1,w:0.05});

    let r=rng(), acc=0, chosen=moves[0]||{dx:1,dy:0};
    for(const m of moves){ acc+=m.w; if(r<=acc){ chosen=m; break; } }
    x=Math.max(0,Math.min(SIZE-1,x+chosen.dx));
    y=Math.max(0,Math.min(SIZE-1,y+chosen.dy));
    if (!path.some(p=>p.x===x && p.y===y)) path.push({x,y});
  }
  path[path.length-1] = {x:castlePos.x, y:castlePos.y};
  return path;
}

function countAround(x,y,board,use8){
  let c=0;
  const dirs8=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];
  const dirs4=[[1,0],[-1,0],[0,1],[0,-1]];
  const dirs = use8?dirs8:dirs4;
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) continue;
    if(board[ny][nx]==="B") c++;
  }
  return c;
}

/* ---- æç”»ã¨æ“ä½œ ---- */
function render(board,revealed,castlePos){
  boardEl.innerHTML = "";
  for(let y=0;y<SIZE;y++){
    for(let x=0;x<SIZE;x++){
      const cell=document.createElement("button");
      cell.type="button"; cell.className="cell";
      cell.setAttribute("role","gridcell");
      cell.setAttribute("aria-label", `y${y+1} x${x+1}`);

      if (x===0) cell.classList.add("start");
      if (x===castlePos.x && y===castlePos.y) cell.classList.add("castle");

      if (revealed[y][x]){
        cell.classList.add("open");
        if (board[y][x]==="B"){
          cell.classList.add("trap"); cell.textContent="ğŸ’¥";
        }else{
          const n=board[y][x];
          if (n===0){ cell.classList.add("safe0"); cell.textContent=""; }
          else{ cell.textContent=n; cell.classList.add("num"+Math.min(8,Math.max(1,n))); }
        }
      }

      cell.addEventListener("click", ()=> openCell(y,x,board,revealed,castlePos));
      cell.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openCell(y,x,board,revealed,castlePos); } });

      boardEl.appendChild(cell);
    }
  }
}

function openCell(y,x,board,revealed,castlePos){
  if (revealed[y][x]) return;
  revealed[y][x] = true;

  if (board[y][x]==="B"){
    msg("ğŸ’¥ ç½ ã«ã‹ã‹ã£ãŸï¼"); vibrate(40);
    revealAll(revealed); render(board,revealed,castlePos); return;
  }
  // 0ãªã‚‰ä¸Šä¸‹å·¦å³ã«é€£é–ã‚ªãƒ¼ãƒ—ãƒ³
  if (board[y][x]===0) floodRevealZeros(y,x,board,revealed);

  render(board,revealed,castlePos);

  if (checkClear(revealed,board,castlePos)){
    msg("ğŸ‰ æ½œå…¥æˆåŠŸï¼"); vibrate([20,30,20]);
    revealAll(revealed); render(board,revealed,castlePos);
  }
}

function floodRevealZeros(sy,sx,board,revealed){
  const q=[{y:sy,x:sx}];
  while(q.length){
    const {y,x}=q.shift();
    for(const [dx,dy] of [[1,0],[-1,0],[0,1],[0,-1]]){
      const nx=x+dx, ny=y+dy;
      if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) continue;
      if(revealed[ny][nx]) continue;
      if(board[ny][nx]==="B") continue;
      revealed[ny][nx]=true;
      if(board[ny][nx]===0) q.push({y:ny,x:nx});
    }
  }
}

function checkClear(revealed,board,castlePos){
  // å·¦ç«¯ã®é–‹ã„ãŸå®‰å…¨ãƒã‚¹ã‹ã‚‰4æ–¹å‘ã§ğŸ¯ã¸åˆ°é”ã§ããŸã‚‰ã‚¯ãƒªã‚¢
  const vis = Array.from({length:SIZE},()=>Array(SIZE).fill(false));
  const q=[];
  for(let y=0;y<SIZE;y++){
    if (revealed[y][0] && board[y][0]!=="B"){ q.push({y,x:0}); vis[y][0]=true; }
  }
  while(q.length){
    const {y,x}=q.shift();
    if (x===castlePos.x && y===castlePos.y) return true;
    for(const [dx,dy] of [[1,0],[-1,0],[0,1],[0,-1]]){
      const nx=x+dx, ny=y+dy;
      if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) continue;
      if(vis[ny][nx]) continue;
      if(revealed[ny][nx] && board[ny][nx]!=="B"){ vis[ny][nx]=true; q.push({y:ny,x:nx}); }
    }
  }
  return false;
}

function revealAll(revealed){
  for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++) revealed[y][x]=true;
}

function msg(t){ msgEl.textContent=t; }
function status(t){ statusEl.textContent=t; }
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); }

/* åˆæœŸèµ·å‹•ã¯â€œæ—¥æ›¿ã‚ã‚Šä»»å‹™â€ */
startDaily();
</script>
</body>
</html>
