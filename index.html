<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å¿è€…æ½œå…¥ã®è¡“ ğŸ—¡ï¸ğŸ¯</title>

<!-- âœ… SEO -->
<meta name="description" content="ç½ ã‚’èª­ã¿è§£ãã€æœ¬ä¸¸â€œã¾ã§â€ã®æ½œå…¥ãƒ«ãƒ¼ãƒˆã‚’é–‹ã‘ãŸã‚‰ã‚¯ãƒªã‚¢ã€‚ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼é¢¨ã®åˆ°é”å‹ãƒ‘ã‚ºãƒ«ã€å¿è€…æ½œå…¥ã®è¡“ã€ã€‚æ—¥æ›¿ã‚ã‚Šä»»å‹™ãƒ»é›£æ˜“åº¦åˆ‡æ›¿ãƒ»Xã‚·ã‚§ã‚¢å¯¾å¿œã€‚" />
<meta name="keywords" content="ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼, å¿è€…, ãƒ‘ã‚ºãƒ«, è«–ç†, ç„¡æ–™, ã‚¹ãƒãƒ›, åˆ°é”å‹, Webã‚¢ãƒ—ãƒª" />

<!-- âœ… OGP / X -->
<meta property="og:title" content="å¿è€…æ½œå…¥ã®è¡“" />
<meta property="og:description" content="ç½ ã‚’èª­ã¿è§£ãã€æœ¬ä¸¸â€œã¾ã§â€ã®æ½œå…¥ãƒ«ãƒ¼ãƒˆã‚’é–‹ã‘ãŸã‚‰ã‚¯ãƒªã‚¢ï¼æ—¥æ›¿ã‚ã‚Šä»»å‹™ã‚ã‚Šã€‚" />
<meta property="og:image" content="card.png" />
<meta property="og:url" content="https://example.com/" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />

<link rel="icon" href="favicon.ico" />

<!-- âœ… Google Analyticsï¼ˆã„ã¤ã‚‚ã®ï¼‰ -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2LM85GJN0L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-2LM85GJN0L');
</script>

<style>
  :root{
    --bg:#0a0f1c; --panel:#111a2e; --accent:#8bd3ff; --text:#eef3ff; --muted:#a8b7d3;
    --cell:40px;
    /* æœªã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆæŠ¼ã›ã‚‹ï¼‰ */
    --cell-covered:#16264a; 
    --cell-covered-border:#3b5a93;
    --cell-covered-hover:#1d3564;
    /* ã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆæŠ¼ã—çµ‚ã‚ã‚Šï¼‰ */
    --cell-open:#0f1a33; 
    --cell-open-border:#2e4677;
    --flag:#ffcc66; --trap:#ff6b6b;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:linear-gradient(180deg,#091327 0%, #0a0f1c 100%);
    color:var(--text); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    display:flex; flex-direction:column; align-items:center;
  }
  header{ width:100%; max-width:980px; padding:16px 16px 0; text-align:center }
  h1{ margin:6px 0 8px; font-size:1.7rem; letter-spacing:.02em }
  .sub{ color:var(--muted); font-size:.95rem }

  .bar{
    width:100%; max-width:980px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:12px 16px;
  }
  select,button{
    background:var(--panel); color:var(--text); border:2px solid #23365a; border-radius:14px;
    padding:10px 14px; font-size:1rem; font-weight:600;
    box-shadow:0 3px 10px rgba(0,0,0,.35);
  }
  button:hover{ filter:brightness(1.08) }
  button:active{ transform:translateY(1px) }
  .badge{
    padding:10px 14px; border-radius:12px; background:#0e1a39; color:#d8e7ff; border:2px solid #2a4272;
    min-width:92px; text-align:center; font-weight:700; letter-spacing:.04em
  }

  #boardWrap{ width:100%; max-width:980px; flex:1; display:flex; align-items:center; justify-content:center; padding:8px 16px 16px }
  #board{
    display:grid; gap:6px; touch-action:manipulation; background:#0c1530; padding:12px; border-radius:18px; border:2px solid #243a64;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), 0 14px 38px rgba(0,0,0,.45);
  }

  /* ===== ãƒã‚¹ã®è¦–è¦šå·®ï¼ˆæœªã‚ªãƒ¼ãƒ—ãƒ³/ã‚ªãƒ¼ãƒ—ãƒ³ï¼‰ ===== */
  .cell{
    width:var(--cell); height:var(--cell); display:flex; align-items:center; justify-content:center;
    user-select:none; line-height:1; position:relative;
    font-weight:900; font-size:calc(var(--cell) * 0.55);
    border-radius:12px; color:#e9f1ff;
    transition:filter .12s ease, transform .05s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .cell.covered{
    background:linear-gradient(180deg,var(--cell-covered), #132650);
    border:2px solid var(--cell-covered-border);
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 4px 12px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
    cursor:pointer;
  }
  .cell.covered:hover{ background:var(--cell-covered-hover); }
  .cell.covered.interactable{
    box-shadow:0 2px 0 rgba(0,0,0,.35), 0 4px 12px rgba(0,0,0,.35), 0 0 0 2px rgba(139,211,255,.25), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .cell.flag{ cursor:default; }
  .cell.flag::after{
    content:"âš‘"; position:absolute; font-size:calc(var(--cell) * 0.55); color:var(--flag);
    text-shadow:0 0 8px rgba(255,204,102,.45);
  }

  .cell.open{
    background:linear-gradient(180deg,var(--cell-open), #0a1430);
    border:2px solid var(--cell-open-border);
    box-shadow:inset 0 2px 8px rgba(0,0,0,.45);
    cursor:default;
    filter:saturate(.92) brightness(.98);
  }
  .cell.open.is-number{
    cursor:pointer;
    box-shadow:inset 0 2px 8px rgba(0,0,0,.45), 0 0 0 2px rgba(139,211,255,.18);
  }
  .cell.goal::after{ content:"ğŸ¯"; position:absolute; font-size:calc(var(--cell) * 0.55) }
  .cell.start::after{ content:"â›©ï¸"; position:absolute; font-size:calc(var(--cell) * 0.5) }

  /* æ•°å­—è‰²ï¼ˆè‰²å¼±é…æ…®ãƒ»é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼‰ */
  .n0{color:#b7c7e6} .n1{color:#74b6ff} .n2{color:#ffb354} .n3{color:#c3a1ff}
  .n4{color:#89ddff} .n5{color:#ffd95e} .n6{color:#6fe8a1} .n7{color:#ff9090} .n8{color:#ffffff}

  .lost{ animation:lostFlash .15s 3 }
  @keyframes lostFlash{ 0%{filter:none} 50%{filter:hue-rotate(-20deg) brightness(1.4)} 100%{filter:none} }

  /* åˆ°é”ï¼ˆçªç ´ï¼‰æ¼”å‡º */
  .cell.goal.reached{
    background:linear-gradient(180deg,#ffd700,#ffb300)!important;
    border-color:#ffec6e!important; color:#000!important;
    animation:glow 1.2s ease-in-out infinite alternate;
  }
  @keyframes glow{ 0%{ box-shadow:0 0 8px rgba(255,215,0,.5) } 100%{ box-shadow:0 0 18px rgba(255,215,0,.95) } }

  footer{ width:100%; max-width:980px; padding:16px; text-align:center; color:var(--muted) }
  #footer{ border-top:1px solid #243a64; margin-top:12px; padding-top:12px; font-size:.98rem }
  a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }

  /* â–¼â–¼ å¿è¡“æŒ‡å—æ›¸ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ â–¼â–¼ */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:18px; z-index:50;
  }
  .modal{
    width:min(680px, 100%); max-height:85vh; overflow:auto;
    background:#0f1a33; border:2px solid #2b4270; border-radius:16px; box-shadow:0 18px 48px rgba(0,0,0,.6);
  }
  .modal header{
    position:sticky; top:0; background:#0f1a33; padding:14px 16px; border-bottom:1px solid #23365a;
  }
  .modal h2{ margin:0; font-size:1.3rem }
  .modal .body{ padding:14px 16px 18px; color:#dde7ff; line-height:1.75 }
  .modal .body h3{ margin:14px 0 6px; font-size:1.05rem; color:#9fd1ff }
  .modal .body ul{ margin:6px 0 12px 1.2em }
  .modal footer{ padding:12px 16px 16px }
  .modal .closeBtn{ width:100%; padding:12px 14px; border-radius:12px; background:#132144; color:#eaf1ff; border:2px solid #2b4270; font-weight:700 }
  .show{ display:flex }

  @media (max-width:420px){
    .badge{ min-width:88px }
  }
</style>
</head>
<body>

<header>
  <h1>å¿è€…æ½œå…¥ã®è¡“ ğŸ—¡ï¸ğŸ¯</h1>
  <div class="sub">ç½ ã‚’èª­ã¿è§£ãã€å·¦ç«¯ã®é–€ã‹ã‚‰å³ç«¯ã®æœ¬ä¸¸<span aria-hidden="true">â€œã¾ã§â€</span>æ½œå…¥ãƒ«ãƒ¼ãƒˆã‚’é–‹ã‘ã‚ã€‚</div>

  <div class="bar">
    <label>é›£æ˜“åº¦ï¼š
      <select id="difficulty">
        <option value="easy">ç”ºï¼ˆ9Ã—9ï¼‰</option>
        <option value="normal" selected>åŸé–€ï¼ˆ12Ã—12ï¼‰</option>
        <option value="hard">æœ¬ä¸¸ï¼ˆ16Ã—16ï¼‰</option>
      </select>
    </label>
    <button id="newGameBtn">æ–°ã—ã„ä»»å‹™</button>
    <button id="dailyBtn">æ—¥æ›¿ã‚ã‚Šä»»å‹™</button>
    <div class="badge" id="timer">00:00</div>
    <div class="badge" id="flags">æ—— 0</div>
    <div class="badge" id="score">å¾—ç‚¹ 0</div>
    <button id="shareBtn">Xã§å…±æœ‰</button>
    <button id="helpBtn" aria-haspopup="dialog" aria-controls="helpModal">å¿è¡“æŒ‡å—æ›¸</button>
  </div>
</header>

<div id="boardWrap">
  <div id="board" aria-label="ã‚²ãƒ¼ãƒ ç›¤é¢" role="grid"></div>
</div>

<footer>
  <div class="sub">æ“ä½œï¼šã‚¿ãƒƒãƒ—=é–‹ãï½œé•·æŠ¼ã—=æ——ï½œæ•°å­—ã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—=åˆå›³é–‹ã‘</div>
  <div id="footer">
    X <a href="https://x.com/kkp_webninja" target="_blank">@kkp_webninja</a> <br>
    ğŸ¯ <a href="https://kkpwebninja.com" target="_blank">webå¿è€…ã®æœ¬ä¸¸</a><br>
  </div>
</footer>

<!-- ğŸ“œ å¿è¡“æŒ‡å—æ›¸ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
<div id="helpBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="modal" id="helpModal">
    <header><h2 id="helpTitle">å¿è¡“æŒ‡å—æ›¸ï¼ˆãƒ«ãƒ¼ãƒ«ï¼‰</h2></header>
    <div class="body">
      <h3>ğŸ¯ ç›®çš„</h3>
      <ul>
        <li><b>é–€ï¼ˆâ›©ï¸ï¼‰ã‹ã‚‰æœ¬ä¸¸ï¼ˆğŸ¯ï¼‰â€œã¾ã§â€ã®å®‰å…¨ãªæ½œå…¥ãƒ«ãƒ¼ãƒˆ</b>ã‚’<b>é–‹ã„ãŸçŠ¶æ…‹ã§ã¤ãªã’ãŸã‚‰</b>ã‚¯ãƒªã‚¢ã€‚</li>
        <li>æœ¬ä¸¸ãƒã‚¹è‡ªä½“ã‚’é–‹ã‹ãªãã¦ã‚‚ã€éš£æ¥ã¾ã§åˆ°é”ã§ãã¦ã„ã‚Œã°OKã€‚</li>
      </ul>
      <h3>ğŸ•¹ æ“ä½œ</h3>
      <ul>
        <li><b>ã‚¿ãƒƒãƒ—</b>ï¼šãƒã‚¹ã‚’é–‹ã</li>
        <li><b>é•·æŠ¼ã—ï¼ˆç´„0.45ç§’ï¼‰</b>ï¼šæ——ã‚’ç«‹ã¦ã‚‹ï¼ˆç½ ã¨æ¨å®šï¼‰</li>
        <li><b>æ•°å­—ãƒã‚¹ã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—</b>ï¼šæ•°å­—ï¼å‘¨å›²ã®æ——æ•°ã§ä¸€æ‹¬ã‚ªãƒ¼ãƒ—ãƒ³</li>
      </ul>
      <h3>ğŸ§  æ•°å­—ã®æ„å‘³</h3>
      <ul><li>æ•°å­—ã¯ã€ãã®ãƒã‚¹ã®<b>å‘¨å›²8ãƒã‚¹ã«ã‚ã‚‹ç½ ã®æ•°</b>ã€‚</li></ul>
      <h3>ğŸ’£ ç½ ï¼ˆå¤±æ•—ï¼‰</h3>
      <ul><li>ç½ ã‚’é–‹ãã¨å³å¤±æ•—ã€‚</li></ul>
      <h3>ğŸ† ã‚¯ãƒªã‚¢æ¼”å‡º</h3>
      <ul><li>åˆ°é”æ™‚ã«ğŸ¯ãŒé‡‘è‰²ã«ç‚¹æ»…ã€‚</li></ul>
    </div>
    <footer><button class="closeBtn" id="helpCloseBtn">é–‰ã˜ã‚‹</button></footer>
  </div>
</div>

<script>
/* ===== å¿è€…æ½œå…¥ã®è¡“ - â€œãƒ«ãƒ¼ãƒˆã‚’é–‹ã‘ãŸã‚‰OKâ€ç‰ˆ ===== */
function mulberry32(a){ return function(){ var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function strToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
function pad(n){return n.toString().padStart(2,'0')}

const DIFFS = { easy:{w:9,h:9,density:0.12}, normal:{w:12,h:12,density:0.15}, hard:{w:16,h:16,density:0.18} };
const STATE = { board:null, rng:Math.random, running:false, startTs:0, timerId:null, flagsLeft:0, opened:0, lost:false, won:false, seed:'', diff:'normal', start:{x:0,y:0}, goal:{x:0,y:0}, score:0 };

const elBoard = document.getElementById('board');
const elTimer = document.getElementById('timer');
const elFlags = document.getElementById('flags');
const elScore = document.getElementById('score');
const elDiff  = document.getElementById('difficulty');

document.getElementById('newGameBtn').addEventListener('click', ()=>startNew());
document.getElementById('dailyBtn').addEventListener('click', ()=>startDaily());
document.getElementById('shareBtn').addEventListener('click', shareToX);
elDiff.addEventListener('change', ()=>startNew());

/* --- å¿è¡“æŒ‡å—æ›¸ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
const helpBtn = document.getElementById('helpBtn');
const helpBackdrop = document.getElementById('helpBackdrop');
const helpCloseBtn = document.getElementById('helpCloseBtn');
helpBtn.addEventListener('click', ()=>{ helpBackdrop.classList.add('show'); helpCloseBtn.focus(); });
helpCloseBtn.addEventListener('click', ()=>{ helpBackdrop.classList.remove('show'); helpBtn.focus(); });
helpBackdrop.addEventListener('click', (e)=>{ if(e.target===helpBackdrop){ helpBackdrop.classList.remove('show'); helpBtn.focus(); }});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && helpBackdrop.classList.contains('show')){ helpBackdrop.classList.remove('show'); helpBtn.focus(); }});

/* --- ç›¤é¢ç”Ÿæˆ --- */
function neighbors8(x,y,W,H){
  const out=[]; for(let dy=-1; dy<=1; dy++){ for(let dx=-1; dx<=1; dx++){
    if(dx===0 && dy===0) continue; const nx=x+dx, ny=y+dy; if(nx>=0 && nx<W && ny>=0 && ny<H) out.push({x:nx,y:ny});
  }} return out;
}
function newBoard(diffKey, seedStr){
  const diff = DIFFS[diffKey];
  const seed = seedStr || (Date.now().toString(36));
  STATE.rng = mulberry32(strToSeed(seed)); STATE.seed = seed; STATE.diff = diffKey; STATE.lost=false; STATE.won=false; STATE.score=0;

  const W=diff.w, H=diff.h;
  const cells = Array.from({length:H},(_,y)=>Array.from({length:W},(_,x)=>({ x,y,isTrap:false,number:0,state:'covered' })));

  const startY = Math.floor(STATE.rng()*H);
  const goalY  = Math.floor(STATE.rng()*H);
  STATE.start={x:0,y:startY}; STATE.goal={x:W-1,y:goalY};

  carveSafePath(cells,W,H,STATE.start,STATE.goal);
  placeTraps(cells, Math.floor(W*H*diff.density));
  computeNumbers(cells,W,H);

  if(!reachableSafe(cells,W,H,STATE.start,STATE.goal)){
    return newBoard(diffKey, seedStr ? seedStr+'a' : null);
  }
  return {W,H,cells};
}
function carveSafePath(cells,W,H,start,goal){
  let x=start.x, y=start.y; cells[y][x].safePath=true;
  const maxSteps=W*H*3; let steps=0;
  while((x!==goal.x || y!==goal.y) && steps<maxSteps){
    steps++;
    const moves=[];
    if(x<goal.x) moves.push({dx:1,dy:0,w:0.5});
    if(y>goal.y) moves.push({dx:0,dy:-1,w:0.22});
    if(y<goal.y) moves.push({dx:0,dy:1,w:0.22});
    moves.push({dx:1,dy:(STATE.rng()<0.5?-1:1),w:0.06});
    const r=STATE.rng(); let acc=0, chosen=moves[0];
    for(const m of moves){ acc+=m.w; if(r<=acc){ chosen=m; break; } }
    x=Math.max(0, Math.min(W-1, x+chosen.dx)); y=Math.max(0, Math.min(H-1, y+chosen.dy));
    cells[y][x].safePath=true;
  }
  cells[start.y][start.x].safePath=true; cells[goal.y][goal.x].safePath=true;
}
function placeTraps(cells,target){
  const H=cells.length, W=cells[0].length;
  let placed=0, guard=0, maxGuard=W*H*4;
  while(placed<target && guard++<maxGuard){
    const x=Math.floor(STATE.rng()*W), y=Math.floor(STATE.rng()*H);
    const c=cells[y][x]; if(c.safePath || c.isTrap) continue;
    c.isTrap=true; placed++;
  }
}
function computeNumbers(cells,W,H){
  for(let y=0;y<H;y++){ for(let x=0;x<W;x++){
    const c=cells[y][x]; if(c.isTrap){ c.number=-1; continue; }
    let n=0; for(const nb of neighbors8(x,y,W,H)){ if(cells[nb.y][nb.x].isTrap) n++; } c.number=n;
  }}
}
function reachableSafe(cells,W,H,start,goal){
  const q=[start]; const seen=new Set([start.x+','+start.y]);
  while(q.length){
    const p=q.shift(); if(p.x===goal.x && p.y===goal.y) return true;
    for(const nb of neighbors8(p.x,p.y,W,H)){
      const key=nb.x+','+nb.y; const c=cells[nb.y][nb.x];
      if(c.isTrap) continue; if(!seen.has(key)){ seen.add(key); q.push(nb); }
    }
  } return false;
}

/* --- æç”»ãƒ»UI --- */
function mountBoard({W,H,cells}){
  STATE.board={W,H,cells};
  STATE.flagsLeft = 0; STATE.opened=0; STATE.running=false; STATE.lost=false; STATE.won=false;

  const wrapW = document.getElementById('boardWrap').clientWidth - 40;
  const cell = Math.max(30, Math.min(56, Math.floor((wrapW - (W-1)*6 - 24) / W)));
  document.documentElement.style.setProperty('--cell', cell+'px');

  elBoard.style.gridTemplateColumns = `repeat(${W}, var(--cell))`;
  elBoard.innerHTML='';
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const c=cells[y][x];
      const div=document.createElement('div');
      div.className='cell covered interactable';
      div.setAttribute('role','gridcell');
      div.dataset.x=x; div.dataset.y=y;
      if(x===STATE.start.x && y===STATE.start.y) div.classList.add('start');
      if(x===STATE.goal.x && y===STATE.goal.y) div.classList.add('goal');
      attachCellHandlers(div);
      elBoard.appendChild(div);
    }
  }
  updateFlagsUI();
}
function updateFlagsUI(){ elFlags.textContent = `æ—— ${STATE.flagsLeft}`; }
function startTimer(){ clearInterval(STATE.timerId); STATE.startTs = Date.now(); STATE.running=true;
  STATE.timerId=setInterval(()=>{ if(!STATE.running) return;
    const s = Math.floor((Date.now()-STATE.startTs)/1000);
    elTimer.textContent = `${pad(Math.floor(s/60))}:${pad(s%60)}`;
  }, 200);
}
function stopTimer(){ STATE.running=false; clearInterval(STATE.timerId); }
function getCellEl(x,y){ return elBoard.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`); }

/* --- ãƒ«ãƒ¼ãƒˆåˆ°é”åˆ¤å®šï¼ˆæ–°ãƒ«ãƒ¼ãƒ«ï¼‰ --- */
function isRouteOpenToGoal(){
  const {W,H,cells}=STATE.board;
  const s = STATE.start, g = STATE.goal;

  // ã‚¹ã‚¿ãƒ¼ãƒˆãŒé–‹ã‹ã‚Œã¦ã„ãªã‘ã‚Œã°â€œæ½œå…¥é–‹å§‹ã—ã¦ã„ãªã„â€ã¨ã¿ãªã™
  if(cells[s.y][s.x].state!=='open') return false;

  // BFSï¼šé–‹ã‹ã‚ŒãŸå®‰å…¨ãƒã‚¹ã®ã¿ã§æ¢ç´¢
  const q=[{x:s.x,y:s.y}], seen=new Set([s.x+','+s.y]);
  const goalKey = g.x+','+g.y;
  const goalNeighbors = neighbors8(g.x,g.y,W,H).map(p=>p.x+','+p.y);
  while(q.length){
    const p=q.shift();
    const key=p.x+','+p.y;

    // 1) æœ¬ä¸¸ãƒã‚¹è‡ªä½“ãŒé–‹ã‹ã‚Œã¦ã„ã¦åˆ°é”ã§ããŸ
    if(key===goalKey && cells[g.y][g.x].state==='open') return true;

    // 2) æœ¬ä¸¸ã®éš£æ¥ãƒã‚¹ã«åˆ°é”ã—ãŸï¼ˆgoalã¯æœªã‚ªãƒ¼ãƒ—ãƒ³ã§ã‚‚OKï¼‰
    if(goalNeighbors.includes(key)) return true;

    for(const nb of neighbors8(p.x,p.y,W,H)){
      const nbKey=nb.x+','+nb.y;
      const c=cells[nb.y][nb.x];
      if(seen.has(nbKey)) continue;
      if(c.state==='open' && !c.isTrap){ seen.add(nbKey); q.push(nb); }
    }
  }
  return false;
}

/* --- ã‚²ãƒ¼ãƒ æ“ä½œ --- */
function openCell(x,y, viaChord=false){
  if(STATE.lost||STATE.won) return;
  const c = STATE.board.cells[y][x]; const el = getCellEl(x,y);
  if(c.state==='open' || c.state==='flag') return;
  if(!STATE.running){ startTimer(); }

  c.state='open';
  el.classList.remove('covered','flag','interactable');
  el.classList.add('open');

  if(c.isTrap){
    el.textContent='âœ–'; el.style.color='var(--trap)'; lose(x,y); return;
  }
  STATE.opened++;
  if(c.number>0){
    el.textContent=c.number;
    el.classList.add('n'+c.number, 'is-number');
  }else{
    el.textContent='';
    floodOpenZeros(x,y);
  }
  updateScore(STATE.score + (viaChord? 4 : (c.number===0? 9:7)));

  // â˜… æ–°ãƒ«ãƒ¼ãƒ«ï¼šãƒ«ãƒ¼ãƒˆãŒç¹‹ãŒã£ãŸã‚‰å³ã‚¯ãƒªã‚¢
  if(isRouteOpenToGoal()){ win(); }
}
function floodOpenZeros(sx,sy){
  const {W,H,cells} = STATE.board;
  const q=[{x:sx,y:sy}], seen=new Set([sx+','+sy]);
  while(q.length){
    const p=q.shift();
    for(const nb of neighbors8(p.x,p.y,W,H)){
      const key=nb.x+','+nb.y; if(seen.has(key)) continue;
      const c=cells[nb.y][nb.x];
      if(c.state!=='open' && !c.isTrap){
        c.state='open';
        const el=getCellEl(nb.x,nb.y);
        el.classList.remove('covered','flag','interactable'); 
        el.classList.add('open');
        if(c.number>0){ el.textContent=c.number; el.classList.add('n'+c.number,'is-number'); }
        else{ el.textContent=''; q.push(nb); }
        STATE.opened++;
      }
      seen.add(key);
    }
  }
  // 0é€£é–å¾Œã‚‚å‹åˆ©ãƒã‚§ãƒƒã‚¯
  if(isRouteOpenToGoal()){ win(); }
}
function toggleFlag(x,y){
  if(STATE.lost||STATE.won) return;
  const c=STATE.board.cells[y][x]; if(c.state==='open') return;
  const el=getCellEl(x,y);
  if(c.state==='flag'){
    c.state='covered'; el.classList.remove('flag'); el.classList.add('interactable'); STATE.flagsLeft--;
  }else{
    c.state='flag'; el.classList.add('flag'); el.classList.remove('interactable'); STATE.flagsLeft++;
  }
  updateFlagsUI();
}
function chordOpen(x,y){
  const c=STATE.board.cells[y][x]; if(c.state!=='open' || c.number<=0) return;
  const {W,H,cells}=STATE.board; const around = neighbors8(x,y,W,H);
  const flags = around.filter(p=>cells[p.y][p.x].state==='flag').length;
  if(flags!==c.number) return;
  for(const nb of around){ const nc=cells[nb.y][nb.x]; if(nc.state==='covered') openCell(nb.x,nb.y,true); }
  // åˆå›³é–‹ã‘å¾Œã‚‚å‹åˆ©ãƒã‚§ãƒƒã‚¯ï¼ˆopenCellå†…ã§å‹åˆ©ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼‰
}
function lose(x,y){
  STATE.lost=true; stopTimer(); revealAll(true, x,y);
  elBoard.classList.add('lost'); setTimeout(()=>elBoard.classList.remove('lost'), 500);
  gtag('event','lose',{diff:STATE.diff,seed:STATE.seed});
}
function win(){
  if(STATE.won) return;
  STATE.won=true; stopTimer();
  const sec = Math.floor((Date.now()-STATE.startTs)/1000);
  const timeBonus = Math.max(0, 300 - sec)*2;
  updateScore(STATE.score + 1000 + timeBonus);

  // æœ¬ä¸¸ã‚’ç¥ç¦æ¼”å‡ºï¼ˆæœªã‚ªãƒ¼ãƒ—ãƒ³ã§ã‚‚OKã§å…‰ã‚‰ã›ã‚‹ï¼‰
  const goalEl = getCellEl(STATE.goal.x, STATE.goal.y);
  goalEl.classList.add('reached');
  if(goalEl.textContent==='') goalEl.textContent='ğŸ¯';

  gtag('event','win',{diff:STATE.diff,seed:STATE.seed,sec,score:STATE.score});
  alert(`æ½œå…¥æˆåŠŸï¼ æœ¬ä¸¸ã¾ã§ã®ãƒ«ãƒ¼ãƒˆç¢ºä¿\næ™‚é–“ ${sec}s / ã‚¹ã‚³ã‚¢ ${STATE.score}`);
}
function revealAll(showTraps=false, hitX=-1,hitY=-1){
  const {W,H,cells}=STATE.board;
  for(let y=0;y<H;y++){ for(let x=0;x<W;x++){
    const c=cells[y][x], el=getCellEl(x,y);
    if(showTraps && c.isTrap){ el.textContent='â€»'; el.style.color='var(--trap)'; el.classList.add('open'); el.classList.remove('covered','interactable'); }
    if(x===hitX && y===hitY){ el.style.outline='3px solid var(--trap)'; }
  }}
}

/* --- å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ© --- */
function attachCellHandlers(el){
  let pressTimer=null, longPressed=false, lastTap=0;
  function onDown(e){ e.preventDefault(); longPressed=false;
    pressTimer=setTimeout(()=>{ longPressed=true; toggleFlag(+el.dataset.x,+el.dataset.y); navigator.vibrate && navigator.vibrate(10); }, 450);
  }
  function onUp(e){ e.preventDefault(); clearTimeout(pressTimer);
    const now=Date.now(), delta=now-lastTap; lastTap=now; const x=+el.dataset.x, y=+el.dataset.y;
    if(longPressed) return;
    if(delta<250){ chordOpen(x,y); } else { openCe
