<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta http-equiv="Content-Security-Policy" content="base-uri 'none'; object-src 'none'; script-src 'self' 'unsafe-inline'">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>ğŸ¥·å¿è€…æ½œå…¥ğŸ¯ â€” sennyu (light)</title>
<style>
  :root{
    --bg:#f5f9ff; --text:#17324d; --cell:50px; --gap:7px;
    --covered1:#eaf2ff; --covered2:#dfeaff; --covered-border:#b9ccff;
    --open1:#ffffff; --open2:#f7fbff; --open-border:#d7e5ff;
    --frontier:#26c281; --frontier-glow:#26c28152; --start-outline:#00a6ff;
    --trap-bg:#ffe1e1; --trap-border:#ff6b6b;
    --ok:#1f9254; --ng:#d24a43; --locked-stripe:#17324d12;

    /* ä¸­å¤®è¡¨ç¤ºã®å¾®èª¿æ•´ï¼ˆä¸­å¤®ã‚ˆã‚Šå°‘ã—ä¸Šï¼‰ */
    --center-nudge-y: -6vh;

    /* ==== é€æ˜åº¦ã‚¢ãƒƒãƒ—ã—ãŸã‚¬ãƒ©ã‚¹è¨­å®š ==== */
    --overlay-dim1: rgba(0,0,0,.08);  /* æš—å¹•ã•ã‚‰ã«è–„ã */
    --overlay-dim2: rgba(0,0,0,.14);
    --panel-bg: rgba(255,255,255,.50);/* ãƒ‘ãƒãƒ«ã®é€æ˜åº¦ï¼šèª­ã¿ã¥ã‚‰ã‘ã‚Œã° .55ï½.60 ã« */
    --panel-border: #cfe0ff99;        /* æ ã‚‚è–„ã‚ã« */
    --panel-shadow: 0 10px 26px rgba(64,103,163,.18);
    --glass-blur: 14px;               /* ã¼ã‹ã—å¼·ã‚ã§å¯èª­æ€§ç¢ºä¿ */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background:
      radial-gradient(1100px 700px at 10% -10%, #cfe2ff88, transparent 60%),
      radial-gradient(1200px 800px at 100% 10%, #ffd7a866, transparent 60%),
      var(--bg);
    display:flex; flex-direction:column; align-items:center;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:-1; opacity:.25;
    background-image:
      radial-gradient(#9dc4ff 1px, transparent 1px),
      radial-gradient(#ffd48a 1px, transparent 1px);
    background-size:28px 28px,28px 28px;
    background-position:0 0,14px 14px;
    animation:bgfloat 20s linear infinite;
  }
  @keyframes bgfloat{from{transform:translateY(0)}to{transform:translateY(28px)}}

  .wrap{width:100%;max-width:980px;padding:14px 16px}
  header h1{margin:.2em 0 .1em}
  .sub{opacity:.9;margin:.2rem 0 .6rem}

  #boardWrap{width:100%; overflow:auto; -webkit-overflow-scrolling:touch; border-radius:16px; margin:.5rem 0; padding-left:max(12px, env(safe-area-inset-left)); padding-right:max(6px, env(safe-area-inset-right));}
  #board{
    display:grid; gap:var(--gap); grid-template-columns:repeat(5,var(--cell));
    width:max-content; padding:14px; background:#eef5ff; border:2px solid #cfe0ff; border-radius:16px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.7), 0 14px 36px rgba(53,87,137,.15);
  }

  .cell{
    width:var(--cell); height:var(--cell); border-radius:12px; position:relative;
    display:flex; align-items:center; justify-content:center; user-select:none;
    font-weight:900; font-size:calc(var(--cell)*0.5);
    background:linear-gradient(180deg,var(--covered1),var(--covered2));
    border:2px solid var(--covered-border); color:#18324e; cursor:pointer;
    transition:transform .06s ease, filter .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .cell:hover{filter:brightness(1.03)} .cell:active{transform:translateY(1px)}
  .cell.open{background:linear-gradient(180deg,var(--open1),var(--open2)); border-color:var(--open-border); cursor:default; box-shadow:inset 0 2px 8px rgba(0,0,0,.05)}
  .cell.locked{cursor:not-allowed; opacity:.75; background:repeating-linear-gradient(135deg,var(--locked-stripe) 0 8px, transparent 8px 16px), linear-gradient(180deg,var(--covered1),var(--covered2));}
  .cell.frontier{box-shadow:0 0 0 3px var(--frontier) inset, 0 0 16px 2px var(--frontier-glow); border-color:#76e2b1; filter:brightness(1.03); animation:pulse 1.2s ease-in-out infinite alternate;}
  @keyframes pulse{0%{box-shadow:0 0 0 2px var(--frontier) inset,0 0 10px 1px var(--frontier-glow)}100%{box-shadow:0 0 0 4px var(--frontier) inset,0 0 22px 4px var(--frontier-glow)}}
  .cell.start{ outline:2px dashed var(--start-outline); outline-offset:-2px }
  .cell.castle::after{ content:"ğŸ¯"; position:absolute; font-size:calc(var(--cell)*0.62) }
  .cell.trap{ background:linear-gradient(180deg,var(--trap-bg),#ffd0d0); border-color:var(--trap-border) }

  .safe0{ color:#7a8aa6 }
  .n1{color:#1f62b5}.n2{color:#1b9b59}.n3{color:#d07a1f}.n4{color:#6e56cf}
  .n5{color:#d55a3a}.n6{color:#178a9b}.n7{color:#bd3f74}.n8{color:#1f2f3d}

  .cell.ninja::before{content:"ğŸ¥·"; position:absolute; right:2px; bottom:2px; font-size:calc(var(--cell)*0.36); line-height:1; pointer-events:none; opacity:.95;}

  .hud{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center; background:#ffffff; border:1px solid #cfe0ff; border-radius:12px; padding:8px 10px; margin-bottom:.5rem; box-shadow:0 8px 22px rgba(64,103,163,.12);}
  .pill{padding:.35em .7em;border-radius:999px;border:1px solid #cfe0ff;background:#eef6ff;font-weight:800;color:#17324d}
  #message{min-height:1.8em;text-align:center;font-weight:900}
  #message.win{color:var(--ok)} #message.lose{color:var(--ng)}
  .bar{display:flex;gap:12px;justify-content:center;margin:.35rem 0; flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,#ffffff,#f1f7ff); border:2px solid #cfe0ff; color:#17324d; border-radius:14px; font-weight:900; cursor:pointer; padding:12px 18px; box-shadow:0 6px 14px rgba(64,103,163,.12)}
  .btn:hover{filter:brightness(1.03)}

  /* ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¬ãƒ©ã‚¹ & ä½ç½®ï¼‰ ===== */
  .overlay{
    position:fixed; inset:0; display:flex; z-index:10;
    background:radial-gradient(ellipse at center, var(--overlay-dim1), var(--overlay-dim2));
  }
  .overlay .panel{
    background:var(--panel-bg);
    border:2px solid var(--panel-border);
    border-radius:18px;
    padding:18px;
    text-align:center;
    width:min(520px,92vw);
    box-shadow:var(--panel-shadow);
    backdrop-filter: blur(var(--glass-blur)) saturate(1.08) brightness(1.02);
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.08) brightness(1.02);
  }
  .overlay .panel .btn{ font-size:1rem; padding:10px 16px }
  .stage-badge{ width:var(--cell); height:var(--cell); display:inline-flex; align-items:center; justify-content:center; border-radius:12px; background:#eef6ff; border:2px solid #cfe0ff; font-weight:900; font-size:calc(var(--cell)*0.34); color:#17324d }
  .hidden{ display:none }

  /* ä½ç½®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
  .pos-center{ align-items:center; justify-content:center; }
  .pos-top{ align-items:flex-start; justify-content:center; padding-top:7vh; }
  .pos-bottom{ align-items:flex-end; justify-content:center; padding-bottom:7vh; }
  .pos-left{ align-items:center; justify-content:flex-start; padding-left:4vw; }
  .pos-right{ align-items:center; justify-content:flex-end; padding-right:4vw; }
  .pos-top-left{ align-items:flex-start; justify-content:flex-start; padding:7vh 0 0 4vw; }
  .pos-top-right{ align-items:flex-start; justify-content:flex-end; padding:7vh 4vw 0 0; }
  .pos-bottom-left{ align-items:flex-end; justify-content:flex-start; padding:0 0 7vh 4vw; }
  .pos-bottom-right{ align-items:flex-end; justify-content:flex-end; padding:0 4vw 7vh 0; }
  /* ä¸­å¤®ã‚’å°‘ã—ä¸Šã¸ï¼ˆç”»é¢ã«å¿œã˜ã¦å¾®èª¿æ•´ï¼‰ */
  .pos-center .panel{ transform: translateY(var(--center-nudge-y)); }
  @media (min-width: 480px){ :root{ --center-nudge-y: -5vh; } }
  @media (min-width: 768px){ :root{ --center-nudge-y: -4vh; } }
  @media (min-height: 740px){ :root{ --center-nudge-y: -7vh; } }

  .shake{ animation:shake .5s ease both } @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
  .boardShine{ position:relative } .boardShine::after{ content:""; position:absolute; inset:0; border-radius:14px; background:linear-gradient(120deg,transparent 0%, rgba(255,255,255,.55) 45%, transparent 55%); transform:translateX(-120%); animation:shine 1.1s ease-out forwards }
  @keyframes shine{to{ transform:translateX(120%) }}
  @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }

  footer{width:100%;max-width:980px;color:#305077b3;padding:16px 16px 28px}
  footer .links{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  footer a{color:#0d7bdc; text-decoration:underline; font-weight:800}
</style>
</head>
<body>
  <header class="wrap">
    <h1>ğŸ¥·å¿è€…æ½œå…¥ğŸ¯</h1>
    <div class="hud">
      <span class="pill" id="verPill">v-</span>
      <span class="pill" id="stagePill">World 1-01</span>
      <span class="pill" id="sizePill">Size: 5Ã—5</span>
      <span class="pill" id="trapPill">ç½ : 6</span>
      <span class="pill">æ•°å­—ï¼ãã®ãƒã‚¹ã®<b>å‘¨å›²8æ–¹å‘</b>ã«ã‚ã‚‹ç½ ã®æ•°</span>
    </div>
    <p class="sub">å·¦ç«¯ã‹ã‚‰<strong>é †ç•ªã«</strong>ï¼ˆä¸Šä¸‹OKï¼å·¦éš£OKï¼æ–œã‚NGï¼‰ã€‚0ã§ã‚‚è‡ªå‹•é€£é–ãªã—ã€‚ã‚¿ãƒƒãƒ—ä½ç½®ã«ğŸ¥·è¡¨ç¤ºã€‚</p>
  </header>

  <main class="wrap">
    <div id="boardWrap"><div id="board" role="grid" aria-label="ã‚²ãƒ¼ãƒ ç›¤é¢"></div></div>
    <div class="bar">
      <button id="restartSame" class="btn" type="button">â†© æœ€åˆã‹ã‚‰</button>
      <button id="retry" class="btn" type="button">ğŸ² ä½œã‚Šç›´ã™</button>
    </div>
    <p id="message" aria-live="polite"></p>
  </main>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆä¸­å¤®ä»˜è¿‘ï¼‰ -->
  <div id="intro" class="overlay hidden" aria-modal="true" role="dialog">
    <div class="panel">
      <div style="display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:10px">
        <span style="opacity:.8">ã‚¹ãƒ†ãƒ¼ã‚¸</span>
        <span id="badge" class="stage-badge">1-01</span>
      </div>
      <button id="start" class="btn" type="button" onclick="window.__sennyuStart&&__sennyuStart(event)">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- æˆå¦ï¼ˆä¸­å¤®ä»˜è¿‘ï¼‰ -->
  <div id="ov" class="overlay hidden" aria-modal="true" role="dialog">
    <div class="panel">
      <h2 id="ovTitle">ğŸ‰ æ½œå…¥æˆåŠŸï¼</h2>
      <p id="ovDesc">æœ¬ä¸¸ã«åˆ°é”ï¼</p>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="next" class="btn" type="button">â¤´ æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
        <button id="again" class="btn" type="button">ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸</button>
      </div>
    </div>
  </div>

  <footer class="wrap">
    <div class="links">
      <a href="https://x.com/kkp_webninja" target="_blank" rel="noopener">X @kkp_webninja</a>
      <span>ï¼</span>
      <a href="https://kkpwebninja.com" target="_blank" rel="noopener">ğŸ¯ kkpwebninja.com</a>
    </div>
  </footer>

<script>
(function(){ 'use strict';
  const VERSION='sennyu-single-2025-08-14-light-Lguard2g-centerGlassMore';
  const UI_POS = { intro: 'center', result: 'center' }; // ä¸­å¤®ä»˜è¿‘ã§è¡¨ç¤º
  const $=(id)=>document.getElementById(id);
  const txt=(el,t)=>{ if(el) el.textContent=t; };

  // ç”»é¢å¹…ã§ãƒã‚¹ã‚µã‚¤ã‚ºï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰
  function setCellSize(){
    const vw=Math.min(window.innerWidth,(document.getElementById('boardWrap')?.clientWidth||window.innerWidth));
    let px=46; if(vw>=420) px=50; if(vw>=560) px=54; if(vw>=768) px=58; if(vw>=1024) px=62;
    document.documentElement.style.setProperty('--cell', px+'px');
  }
  window.addEventListener('resize', setCellSize); setCellSize();

  const boardEl=$('board'), wrapEl=$('boardWrap'), msgEl=$('message');
  const stagePill=$('stagePill'), sizePill=$('sizePill'), trapPill=$('trapPill');
  const intro=$('intro'), startBtn=$('start'), badge=$('badge');
  const ov=$('ov'), ovTitle=$('ovTitle'), ovDesc=$('ovDesc'), nextBtn=$('next'), againBtn=$('again');
  const retryBtn=$('retry'), restartSameBtn=$('restartSame');
  txt($('verPill'), VERSION);

  // ä½ç½®é©ç”¨ãƒ˜ãƒ«ãƒ‘
  function setOverlayPos(el,pos){
    const all=['pos-center','pos-top','pos-bottom','pos-left','pos-right','pos-top-left','pos-top-right','pos-bottom-left','pos-bottom-right'];
    el.classList.remove(...all);
    const ok=new Set(['center','top','bottom','left','right','top-left','top-right','bottom-left','bottom-right']);
    const v = ok.has(pos)?pos:'center';
    el.classList.add('pos-'+v);
  }
  function applyPositions(){
    setOverlayPos(intro, UI_POS.intro);
    setOverlayPos(ov, UI_POS.result);
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¸æ§‹æˆï¼šWorldã”ã¨ã«ç›¤ã‚µã‚¤ã‚ºå›ºå®šã€Subã§ç½ æ•°ãŒ+1
  const MAX_WORLD=5, SUBS=5;
  let world=1, sub=1;
  let SIZE=5, TRAPS=6, board=[], revealed=[], castle={x:4,y:2}, ninja=null;
  let initialBoard=null; // ã€Œæœ€åˆã‹ã‚‰ã€ç”¨ã«åŒä¸€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜

  const sizeOfWorld=(w)=>({1:5,2:6,3:7,4:8,5:9}[w]||9);
  function trapsOf(size, sub){
    const baseBySize={5:5,6:8,7:11,8:15,9:19};        // ã‚„ã‚„æ˜“ã—ã‚
    const base=baseBySize[size] ?? Math.floor(size*size*0.20);
    const start=Math.max(1, base), cap=Math.floor(size*size*0.30);
    return Math.min(cap, start+(sub-1));              // ã‚µãƒ–ã”ã¨ã« +1
  }

  function showIntro(){
    const s=sizeOfWorld(world);
    txt(badge, `${world}-${String(sub).padStart(2,'0')}`);
    txt(stagePill, `World ${world}-${String(sub).padStart(2,'0')}`);
    txt(sizePill,  `Size: ${s}Ã—${s}`);
    txt(trapPill,  `ç½ : ${trapsOf(s, sub)}`);
    intro.classList.remove('hidden');
  }

  function startNow(e){
    if(e){ e.preventDefault?.(); e.stopPropagation?.(); }
    if(intro.classList.contains('hidden')) return;
    intro.classList.add('hidden');
    startStage();
  }
  // ãƒœã‚¿ãƒ³ä»¥å¤–ã§ã¯é–‹å§‹ã—ãªã„
  startBtn.addEventListener('click', startNow);
  startBtn.addEventListener('pointerup', startNow);
  startBtn.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); startNow(e); }});
  window.__sennyuStart=startNow;

  function startStage(attempt=0){
    SIZE=sizeOfWorld(world);
    TRAPS=trapsOf(SIZE, sub);
    castle={x:SIZE-1,y:Math.floor(SIZE/2)};
    txt(stagePill, `World ${world}-${String(sub).padStart(2,'0')}`);
    txt(sizePill,  `Size: ${SIZE}Ã—${SIZE}`);
    txt(trapPill,  `ç½ : ${TRAPS}`);
    txt(msgEl,''); ninja=null;

    board=Array.from({length:SIZE},()=>Array(SIZE).fill(0));
    revealed=Array.from({length:SIZE},()=>Array(SIZE).fill(false));

    const path=buildPath(SIZE, castle.y); path.add(`${castle.x},${castle.y}`);

    // ãƒ©ãƒ³ãƒ€ãƒ ç½ é…ç½®ï¼ˆå·¦ç«¯/ğŸ¯/é€šè·¯ã¯é™¤å¤–ï¼‰
    let placed=0, tries=0, maxTries=SIZE*SIZE*20;
    while(placed<TRAPS && tries++<maxTries){
      const x=Math.floor(Math.random()*SIZE), y=Math.floor(Math.random()*SIZE);
      if(x===0) continue;
      if(x===castle.x && y===castle.y) continue;
      if(path.has(`${x},${y}`)) continue;
      if(board[y][x]==='T') continue;
      board[y][x]='T'; placed++;
    }

    // ç›´ç·šä¾µå…¥å¯¾ç­–ï¼ˆå·¦éš£ãƒ»è¿‘å‚ã‚’è©°ã‚ã‚‹ï¼å·¦å´ã«å¿…ãšç½ ï¼‰
    blockCastleLeft(path);
    enforceCastlePressure(path);
    ensureTrapLeftOfCastle();

    // åˆ°é”æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ€ãƒ¡ãªã‚‰å†ç”Ÿæˆï¼‰
    if(!isReachable()){ if(attempt<60) return startStage(attempt+1); }

    // æ•°å­—è¨ˆç®— & å®Ÿç½ æ•°ã§HUDæ›´æ–°
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      if(board[y][x]!=='T') board[y][x]=count8(x,y);
    }
    const trapCount = board.flat().reduce((a,c)=>a+(c==='T'),0);
    txt(trapPill, `ç½ : ${trapCount}`);

    // åˆæœŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜ï¼ˆâ†©æœ€åˆã‹ã‚‰ ç”¨ï¼‰
    initialBoard = board.map(row=>row.slice());

    draw();
  }

  /* ===== ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ===== */
  function buildPath(size, cy){
    let y=Math.floor(Math.random()*size);
    const s=new Set();
    for(let x=0;x<=size-1;x++){
      s.add(`${x},${y}`);
      // åŸã®å·¦éš£ãŒé€šè·¯ç›´é€šã«ãªã‚‰ãªã„ã‚ˆã†ä¸Šä¸‹ã«ãšã‚‰ã™
      if(x===size-2 && y===cy){ if(y+1<size) y++; else y--; s.add(`${x},${y}`); }
      if(x<size-1){
        if(y<cy && Math.random()<0.5){ y++; s.add(`${x},${y}`); }
        else if(y>cy && Math.random()<0.5){ y--; s.add(`${x},${y}`); }
      }
    }
    while(y<cy){ y++; s.add(`${size-1},${y}`); }
    while(y>cy){ y--; s.add(`${size-1},${y}`); }
    return s;
  }
  function count8(x,y){
    let c=0;
    for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
      if(!dx&&!dy) continue;
      const nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
      if(board[ny][nx]==='T') c++;
    }
    return c;
  }

  // åŸã®å·¦éš£ã‚’ã§ãã‚‹ã ã‘ç½ ã«ï¼ˆé€šè·¯ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  function blockCastleLeft(path){
    const lcx=castle.x-1, lcy=castle.y;
    if(lcx<0) return;
    if(board[lcy][lcx]==='T') return;
    if(path.has(`${lcx},${lcy}`)) return;
    const donors=[];
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      if(board[y][x]!=='T') continue;
      if(x===0) continue;
      if(x===castle.x && y===castle.y) continue;
      if(path.has(`${x},${y}`)) continue;
      donors.push({x,y});
    }
    if(!donors.length) return;
    const d=donors[Math.random()*donors.length|0];
    board[d.y][d.x]=0; board[lcy][lcx]='T';
  }

  // åŸå‰ã«æœ€ä½1å€‹ã®è¿‘æ¥ç½ ï¼ˆæ–œã‚å«ã‚€ï¼‰ã‚’ç¢ºä¿
  function enforceCastlePressure(path){
    const lcx=castle.x-1, lcy=castle.y;
    if(lcx<0) return;
    const hasNear=()=>{
      for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
        if(!dx&&!dy) continue;
        const nx=lcx+dx, ny=lcy+dy;
        if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
        if(board[ny][nx]==='T') return true;
      }
      return false;
    };
    if(hasNear()) return;

    const candidates=[];
    for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
      if(!dx&&!dy) continue;
      const nx=lcx+dx, ny=lcy+dy;
      if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
      if(nx===castle.x && ny===castle.y) continue;
      if(nx===0) continue;
      if(path.has(`${nx},${ny}`)) continue;
      if(board[ny][nx]!=='T') candidates.push({nx,ny}); else return;
    }
    if(!candidates.length) return;
    const donors=[];
    for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++){
      if(board[y][x]==='T' && x!==0 && !(x===castle.x && y===castle.y) && !path.has(`${x},${y}`)){
        const manh=Math.abs(x-(lcx))+Math.abs(y-(lcy));
        if(manh>2) donors.push({x,y});
      }
    }
    if(!donors.length) return;
    const t=candidates[Math.random()*candidates.length|0];
    const d=donors[Math.random()*donors.length|0];
    board[d.y][d.x]=0; board[t.ny][t.nx]='T';
  }

  // â˜…æœ€çµ‚ä¿è¨¼ï¼šåŒã˜è¡Œã®ã€Œå·¦å´ã©ã“ã‹ã€ã«å¿…ãšç½ ï¼ˆå·¦éš£ã‚’å¼·åˆ¶ç½ ï¼‰
  function ensureTrapLeftOfCastle(){
    const y=castle.y, lcx=castle.x-1;
    if(lcx<=0) return; // å·¦ç«¯x=0ã«ã¯ç½®ã‹ãªã„
    for(let x=1;x<=lcx;x++){ if(board[y][x]==='T') return; }
    board[y][lcx]='T';
  }

  // å·¦ç«¯ã©ã“ã‹ã‹ã‚‰ğŸ¯ã¾ã§ã®åˆ°é”æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆä¸Šä¸‹å·¦å³ã®ã¿ï¼‰
  function isReachable(){
    const tx=castle.x, ty=castle.y;
    const seen=Array.from({length:SIZE},()=>Array(SIZE).fill(false));
    const q=[]; for(let y=0;y<SIZE;y++){ q.push([0,y]); seen[y][0]=true; }
    const dirs=[[1,0],[0,1],[0,-1],[-1,0]];
    while(q.length){
      const [x,y]=q.shift();
      if(board[y][x]==='T') continue;
      if(x===tx && y===ty) return true;
      for(const [dx,dy] of dirs){
        const nx=x+dx, ny=y+dy;
        if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) continue;
        if(seen[ny][nx]) continue;
        seen[ny][nx]=true; q.push([nx,ny]);
      }
    }
    return false;
  }

  // å·¦â†’å³ã¸ã€Œå·¦ãƒ»ä¸Šãƒ»ä¸‹ã€ã‹ã‚‰ã®ã¿é–‹ã‘ã‚‰ã‚Œã‚‹ï¼ˆæ–œã‚NGï¼è‡ªå‹•é€£é–ãªã—ï¼‰
  const canOpen=(x,y)=>{
    if(revealed[y][x]) return false;
    if(x===0) return true;
    if(y>0 && revealed[y-1][x]) return true;
    if(y<SIZE-1 && revealed[y+1][x]) return true;
    if(x>0 && revealed[y][x-1]) return true;
    return false;
  };

  function draw(){
    boardEl.style.gridTemplateColumns=`repeat(${SIZE}, var(--cell))`;
    boardEl.innerHTML=''; boardEl.classList.remove('boardShine');
    for(let y=0;y<SIZE;y++){
      for(let x=0;x<SIZE;x++){
        const el=document.createElement('button');
        el.type='button'; el.className='cell'; el.setAttribute('aria-label',`è¡Œ${y+1} åˆ—${x+1}`);
        if(x===0) el.classList.add('start');
        if(x===SIZE-1 && y===Math.floor(SIZE/2)) el.classList.add('castle');

        const allow=canOpen(x,y);
        if(!revealed[y][x]) el.classList.add(allow?'frontier':'locked');
        else{
          el.classList.add('open');
          if(board[y][x]==='T'){ el.classList.add('trap'); el.textContent='ğŸ’¥'; }
          else{
            const n=board[y][x];
            if(n===0) el.classList.add('safe0'); else { el.textContent=n; el.classList.add('n'+n); }
          }
        }
        if(ninja && ninja.x===x && ninja.y===y) el.classList.add('ninja');

        el.addEventListener('click', ()=>onOpen(x,y));
        el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onOpen(x,y); } });
        boardEl.appendChild(el);
      }
    }
  }

  function onOpen(x,y){
    if(!canOpen(x,y)){ txt(msgEl,'å·¦ç«¯â†’åˆ°é”æ¸ˆã¿ã®ä¸Šä¸‹å·¦å³ã ã‘é–‹ã‘ã‚‰ã‚Œã¾ã™ã€‚'); return; }
    if(revealed[y][x]) return;
    revealed[y][x]=true; ninja={x,y};

    if(board[y][x]==='T'){
      txt(msgEl,'ğŸ’¥ ä»»å‹™å¤±æ•—â€¦');
      wrapEl.classList.add('shake'); setTimeout(()=>wrapEl.classList.remove('shake'),600);
      revealAll(); draw(); showLose(); return;
    }
    draw();
    if(x===SIZE-1 && y===Math.floor(SIZE/2)){
      txt(msgEl,'ğŸ‰ æ½œå…¥æˆåŠŸï¼'); boardEl.classList.add('boardShine'); confettiFX();
      revealAll(); draw(); showWin();
    }
  }

  const revealAll=()=>{ for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++) revealed[y][x]=true; };

  function confettiFX(){
    const EMO=['ğŸ‰','âœ¨','ğŸ’','ğŸ¥·','ğŸ‘‘']; const n=50;
    const lay=document.createElement('div');
    Object.assign(lay.style,{position:'fixed',left:0,top:'-10vh',width:'100%',height:'110vh',pointerEvents:'none',zIndex:11});
    document.body.appendChild(lay);
    for(let i=0;i<n;i++){
      const s=document.createElement('span');
      s.textContent=EMO[i%EMO.length];
      Object.assign(s.style,{position:'absolute',left:Math.random()*100+'%',top:'-10vh',fontSize:(22+Math.random()*10)+'px',animation:`fall ${1.8+Math.random()*1.8}s linear forwards`});
      lay.appendChild(s);
    }
    setTimeout(()=>lay.remove(),2600);
  }

  function showWin(){
    const isFinal=(world===MAX_WORLD && sub===SUBS);
    if(isFinal){
      txt(ovTitle,'ğŸ… å®Œå…¨åˆ¶è¦‡ï¼'); txt(ovDesc,'å…¨25é¢ã‚¯ãƒªã‚¢ï¼æœ€åˆã®çŠ¶æ…‹ï¼ˆ1-1ï¼‰ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚');
    }else{
      txt(ovTitle,'ğŸ‰ æ½œå…¥æˆåŠŸï¼'); txt(ovDesc,'æœ¬ä¸¸ã«åˆ°é”ï¼æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸é€²ã‚ã¾ã™ã€‚');
    }
    $('next').classList.toggle('hidden', isFinal);
    $('again').textContent = isFinal ? 'ğŸ” æœ€åˆã‹ã‚‰' : 'ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸';
    ov.classList.remove('hidden');
  }
  function showLose(){
    txt(ovTitle,'ğŸ’¥ ä»»å‹™å¤±æ•—â€¦'); txt(ovDesc,'ç½ ã«ã‹ã‹ã£ãŸï¼åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸ã§å†æŒ‘æˆ¦ã€‚');
    $('next').classList.add('hidden');
    $('again').textContent='ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸';
    ov.classList.remove('hidden');
  }
  function hideOv(){ ov.classList.add('hidden'); $('next').classList.remove('hidden'); }

  // é€”ä¸­ã§ã‚‚æœ€åˆã‹ã‚‰ï¼ä½œã‚Šç›´ã™
  function resetToInitial(){
    if(!initialBoard) return;
    board = initialBoard.map(row=>row.slice());
    revealed = Array.from({length:SIZE},()=>Array(SIZE).fill(false));
    ninja=null; txt(msgEl,''); draw();
  }
  restartSameBtn.addEventListener('click', resetToInitial);       // â†© æœ€åˆã‹ã‚‰ï¼ˆåŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
  retryBtn.addEventListener('click', ()=>{ hideOv(); startStage(); }); // ğŸ² ä½œã‚Šç›´ã™ï¼ˆæ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å´ã®ãƒœã‚¿ãƒ³
  $('again').addEventListener('click', ()=>{
    const isFinal=(world===MAX_WORLD && sub===SUBS);
    hideOv();
    if(isFinal){ world=1; sub=1; }
    startStage(); // æ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å³å†æŒ‘æˆ¦
  });
  $('next').addEventListener('click', ()=>{
    hideOv();
    if(sub<SUBS){ sub++; } else { sub=1; world=Math.min(MAX_WORLD, world+1); }
    showIntro();
  });

  // åˆæœŸé©ç”¨ & è¡¨ç¤º
  applyPositions();
  showIntro();
})();
</script>
</body>
</html>
