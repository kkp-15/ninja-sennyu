<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å¿è€…æ½œå…¥ğŸ¯ â€” æ®µéšã‚µã‚¤ã‚ºï¼ç¢ºå®Ÿãƒ«ãƒ¼ãƒˆï¼ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥èƒŒæ™¯</title>
<style>
  :root{
    --bg:#070c18; --text:#eef3ff; --muted:#a8b7d3;
    --cell:44px;             /* JSã§ 32ã€œ64 ã«è‡ªå‹•èª¿æ•´ */
    --gap:7px;
    --covered1:#1a2b52; --covered2:#132447; --covered-border:#3a5a94;
    --open1:#0f1b37; --open2:#0a1430; --open-border:#2c497b;
    --frontier:#46e1ff; --frontier-glow:#46e1ff55;
    --locked-stripe:#ffffff15;
    --start-outline:#8bd3ff; --trap-bg:#7a2a2a; --trap-border:#b33a3a;
    --castle-glow:#ffd54f; --focus:#00e5ff;
    --ok:#b4ffb4; --ng:#ff9b9b;
    --panel:#0f1b37; --panel-b:#2a4272;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    display:flex; flex-direction:column; align-items:center;
    background: var(--bg);
    overflow-x:hidden;
  }

  /* === èƒŒæ™¯ï¼šã‚°ãƒ©ãƒ‡ï¼‹ãƒã‚ªãƒ³ã‚°ãƒªãƒƒãƒ‰ï¼‹å…‰ã®ãƒ–ãƒ©ãƒ¼ === */
  .bg{
    position:fixed; inset:-10vmax; z-index:-2; pointer-events:none;
    background:
      radial-gradient(1200px 800px at 10% -10%, #10306666, transparent 60%),
      radial-gradient(1300px 900px at 100% 10%, #2a1a6666, transparent 60%),
      linear-gradient(180deg,#0b1630, #070c18 55%, #060a12);
    filter: saturate(110%);
  }
  .bg::before{
    content:""; position:absolute; inset:0; z-index:-1; opacity:.25;
    background-image:
      radial-gradient(#6fe1ff44 1px, transparent 1px),
      radial-gradient(#6fe1ff33 1px, transparent 1px);
    background-size: 36px 36px, 36px 36px;
    background-position: 0 0, 18px 18px;
    mask-image: radial-gradient(60% 60% at 50% 40%, #000 60%, transparent 100%);
    animation: gridMove 22s linear infinite;
  }
  @keyframes gridMove{ from{ transform: translateY(0px) } to{ transform: translateY(36px) } }
  .glow{ position:fixed; inset:0; pointer-events:none; z-index:-1; }
  .blob{ position:absolute; width:40vmax; height:40vmax; filter:blur(60px);
         opacity:.13; background:radial-gradient(circle at 50% 50%, #4be1ff, transparent 60%);
         animation: float 18s ease-in-out infinite; }
  .blob.b2{ left:60%; top:10%; background:radial-gradient(circle at 50% 50%, #9b6bff, transparent 60%); animation-duration:22s }
  @keyframes float{ 0%,100%{ transform:translate3d(0,0,0) scale(1) } 50%{ transform:translate3d(-4vw,2vh,0) scale(1.05) } }

  .wrap{width:100%;max-width:980px;padding:14px 16px}
  header h1{margin:.2em 0 .1em}
  .sub{color:var(--muted);margin:.1rem 0 .6rem}

  .hud{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center;
    background:var(--panel); border:1px solid var(--panel-b); border-radius:12px; padding:8px 10px; margin-bottom:.5rem;
  }
  .pill{padding:.35em .7em; border-radius:999px; border:1px solid #37568f; background:#0f1b37; font-weight:800}
  .linkbtn{ appearance:none; border:0; background:transparent; color:#8bd3ff; font-weight:800; cursor:pointer; text-decoration:underline; }

  /* ç›¤ï¼šå·¦ç«¯åˆã‚ã›ï¼‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  #boardWrap{
    width:100%;
    display:flex; justify-content:flex-start;
    margin:.5rem 0;
    padding-left:max(12px, env(safe-area-inset-left));
    padding-right:max(6px, env(safe-area-inset-right));
    overflow:auto; -webkit-overflow-scrolling:touch;
    max-height:70vh; border-radius:16px;
  }
  #board{
    --cols:8;
    display:grid; gap:var(--gap); grid-template-columns:repeat(var(--cols),var(--cell));
    width:max-content;
    background:#0b1734; border:2px solid #233a64; padding:14px; border-radius:16px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.05),0 16px 40px rgba(0,0,0,.55);
    touch-action:manipulation;
  }

  .cell{
    width:var(--cell); height:var(--cell); border-radius:12px; position:relative;
    display:flex; align-items:center; justify-content:center; user-select:none;
    font-weight:900; font-size:calc(var(--cell)*0.5);
    background:linear-gradient(180deg,var(--covered1),var(--covered2));
    border:2px solid var(--covered-border); color:#e9f1ff; cursor:pointer;
    transition:transform .06s ease, filter .12s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .cell:hover{filter:brightness(1.07)} .cell:active{transform:translateY(1px)}
  .cell:focus-visible{outline:3px solid var(--focus); outline-offset:2px}

  .cell.open{ background:linear-gradient(180deg,var(--open1),var(--open2)); border-color:var(--open-border); cursor:default; box-shadow:inset 0 3px 10px rgba(0,0,0,.45) }
  .cell.locked{
    cursor:not-allowed; opacity:.50;
    background:repeating-linear-gradient(135deg,var(--locked-stripe) 0 8px,transparent 8px 16px),linear-gradient(180deg,var(--covered1),var(--covered2));
  }
  .cell.frontier{
    box-shadow:0 0 0 3px var(--frontier) inset, 0 0 16px 2px var(--frontier-glow);
    border-color:#4bd3ff; filter:brightness(1.06);
    animation:pulse 1.2s ease-in-out infinite alternate;
  }
  @keyframes pulse{ 0%{ box-shadow:0 0 0 2px var(--frontier) inset, 0 0 10px 1px var(--frontier-glow) }
                    100%{ box-shadow:0 0 0 4px var(--frontier) inset, 0 0 20px 3px var(--frontier-glow) } }
  .cell.start{ outline:2px dashed var(--start-outline); outline-offset:-2px }
  .cell.castle::after{ content:"ğŸ¯"; position:absolute; font-size:calc(var(--cell)*0.62); filter:drop-shadow(0 0 6px rgba(255,213,79,.35)) }
  .cell.trap{ background:linear-gradient(180deg,var(--trap-bg),#4f1111); border-color:var(--trap-border) }
  .safe0{ color:#c6d6f5; opacity:.95 }
  .n1{color:#76b7ff}.n2{color:#55d68c}.n3{color:#ffc14d}.n4{color:#c5a3ff}
  .n5{color:#ff9a6b}.n6{color:#8fe3ff}.n7{color:#ff7d92}.n8{color:#ffffff}

  /* å¿è€…ï¼ˆå³ä¸‹ãƒãƒƒã‚¸ã§æ•°å­—ã‚’éš ã•ãªã„ï¼‰ */
  .cell.ninja::before{
    content:"ğŸ¥·"; position:absolute; right:2px; bottom:2px;
    font-size:calc(var(--cell)*0.36); line-height:1; pointer-events:none;
    filter:drop-shadow(0 0 3px rgba(0,0,0,.4)); opacity:.92; z-index:1;
  }

  .bar{display:flex;gap:12px;justify-content:center;align-items:center;margin:.35rem 0;flex-wrap:wrap}
  .btn{ background:#16264a;border:2px solid #2a4272;color:#eaf1ff;border-radius:14px;font-weight:900;cursor:pointer; box-shadow:0 3px 10px rgba(0,0,0,.35); transition:transform .06s ease,filter .12s ease }
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn-lg{ font-size:1.15rem; padding:14px 22px; width:min(560px,92vw); }

  #message{min-height:1.8em;text-align:center;font-weight:900}
  #message.win{color:var(--ok)} #message.lose{color:var(--ng)}

  .shake{ animation:shake .5s ease both 0s 1 }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-10px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-6px)} 80%{transform:translateX(4px)} }
  .flash{ position:fixed; inset:0; background:rgba(255,0,0,.16); pointer-events:none; animation:flashOut .5s ease both }
  @keyframes flashOut{ from{opacity:.9} to{opacity:0} }

  .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,.7)); z-index:10 }
  .overlay .panel{ background:var(--panel); border:2px solid var(--panel-b); border-radius:18px; padding:22px; text-align:center; width:min(640px,92vw); box-shadow:0 20px 60px rgba(0,0,0,.6) }
  .overlay h2{ margin:.2em 0 .2em; font-size:2rem }
  .hidden{ display:none }

  /* ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒƒã‚¸ï¼ˆã‚»ãƒ«ã¨åŒã‚µã‚¤ã‚ºï¼‰ */
  .stage-badge{
    width:var(--cell); height:var(--cell);
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:12px; background:linear-gradient(180deg,var(--covered1),var(--covered2));
    border:2px solid var(--covered-border);
    font-weight:900; font-size:calc(var(--cell)*0.34); letter-spacing:0.5px; color:#e9f1ff;
    box-shadow:inset 0 3px 10px rgba(0,0,0,.35);
  }
  .badge-row{display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:10px}
  .badge-label{font-size:1rem; color:#cfe2ff99; margin-right:6px}

  /* ã‚¯ãƒªã‚¢æ¼”å‡ºï¼šåŸã‚°ãƒ­ãƒ¼ï¼†ç›¤ã‚­ãƒ©ã‚­ãƒ© */
  .castleGlow .cell.castle::after{ filter:drop-shadow(0 0 10px rgba(255,213,79,.75)) drop-shadow(0 0 20px rgba(255,213,79,.55)) }
  .boardShine{ position:relative }
  .boardShine::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.08) 45%, transparent 55%);
    transform:translateX(-120%); animation:shine 1.2s ease-out forwards; border-radius:14px;
  }
  @keyframes shine{ to{ transform:translateX(120%) } }

  /* ç´™å¹é›ªç”¨ */
  @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }

  footer{width:100%;max-width:980px;color:#cfe2ff99;padding:16px 16px 28px}
  footer .links{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  footer a{color:#8bd3ff; text-decoration:underline; font-weight:800}
</style>
</head>
<body>
  <!-- èƒŒæ™¯ -->
  <div class="bg"></div>
  <div class="glow">
    <div class="blob" style="left:-10%; top:30%"></div>
    <div class="blob b2"></div>
  </div>

  <header class="wrap">
    <h1>å¿è€…æ½œå…¥ğŸ¯</h1>
    <div class="hud" aria-label="èª¬æ˜ã¨é€²è¡ŒçŠ¶æ³">
      <span class="pill" id="worldPill">World 1-01</span>
      <span class="pill" id="sizePill">Size: 5Ã—5</span>
      <span class="pill" id="trapPill">ç½ : 6</span>
      <span class="pill">æ•°å­—ï¼ãã®ãƒã‚¹ã® <b>å‘¨å›²8æ–¹å‘</b> ã«ã‚ã‚‹ç½ ã®æ•°</span>
      <button class="linkbtn" id="resetProgress">é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <p class="sub">
      ãƒ«ãƒ¼ãƒ«ï¼šå·¦ç«¯ã‹ã‚‰<strong>é †ç•ªã«</strong>ï¼ä¸Šä¸‹OKãƒ»æ–œã‚NGï¼0ã§ã‚‚è‡ªå‹•é€£é–ãªã—ã€‚<br>
      è¦‹åˆ†ã‘æ–¹ï¼š<b>å…‰ã‚‹ç¸ï¼ä»Šé–‹ã‘ã‚‰ã‚Œã‚‹</b>ã€<b>æ¿ƒè‰²ï¼é–‹ã„ãŸ</b>ã€<b>ã‚¹ãƒˆãƒ©ã‚¤ãƒ—ï¼ã¾ã </b>ã€‚ã‚¿ãƒƒãƒ—ä½ç½®ã«ğŸ¥·ï¼ˆå³ä¸‹ãƒãƒƒã‚¸ï¼‰è¡¨ç¤ºã€‚
    </p>
  </header>

  <main class="wrap">
    <div id="boardWrap">
      <div id="board" role="grid" aria-label="ã‚²ãƒ¼ãƒ ç›¤é¢"></div>
    </div>

    <div class="bar">
      <button id="retry" class="btn btn-lg">ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚„ã‚Šç›´ã™</button>
    </div>

    <p id="message" aria-live="polite"></p>
  </main>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¸é–‹å§‹ï¼šã‚»ãƒ«ã‚µã‚¤ã‚ºã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒƒã‚¸ï¼‹ã‚¹ã‚¿ãƒ¼ãƒˆ -->
  <div id="stageIntro" class="overlay" aria-modal="true" role="dialog">
    <div class="panel">
      <div class="badge-row">
        <span class="badge-label">ã‚¹ãƒ†ãƒ¼ã‚¸</span>
        <span id="stageBadge" class="stage-badge">1-01</span>
      </div>
      <button id="introStart" class="btn btn-lg">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- æˆå¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="overlay" class="overlay hidden" aria-modal="true" role="dialog">
    <div class="panel">
      <h2 id="ovTitle">ğŸ‰ æ½œå…¥æˆåŠŸï¼</h2>
      <p id="ovDesc">æœ¬ä¸¸ã«åˆ°é”ï¼</p>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button id="ovNext" class="btn btn-lg">â¤´ æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
        <button id="ovRetry" class="btn btn-lg">ğŸ” åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸</button>
      </div>
    </div>
  </div>

  <footer class="wrap">
    <div class="links">
      <a href="https://x.com/kkp_webninja" target="_blank" rel="noopener">X @kkp_webninja</a>
      <span>ï¼</span>
      <a href="https://kkpwebninja.com" target="_blank" rel="noopener">ğŸ¯ kkpwebninja.com</a>
    </div>
  </footer>

<script>
/* ===== æ®µéšã‚µã‚¤ã‚ºï¼ç¢ºå®Ÿãƒ«ãƒ¼ãƒˆï¼ã‚µã‚¤ã‚ºè‡ªå‹•èª¿æ•´ï¼æ¼”å‡º ===== */
(function(){
  const $id=(id)=>document.getElementById(id);
  const safeText=(el,t)=>{ if(el) el.textContent=t; };
  const clamp=(min,max,v)=>Math.max(min, Math.min(max, v));
  const pad2=(n)=>String(n).padStart(2,'0');

  function main(){
    // DOM
    const boardEl   = $id('board');
    const msgEl     = $id('message');
    const sizePill  = $id('sizePill');
    const trapPill  = $id('trapPill');
    const worldPill = $id('worldPill');

    const intro     = $id('stageIntro');
    const introStart= $id('introStart');
    const stageBadge= $id('stageBadge');

    const overlay   = $id('overlay');
    const ovTitle   = $id('ovTitle');
    const ovDesc    = $id('ovDesc');
    const ovNext    = $id('ovNext');
    const ovRetry   = $id('ovRetry');

    const retryBtn  = $id('retry');
    const resetBtn  = $id('resetProgress');

    if(!boardEl||!msgEl||!sizePill||!trapPill||!worldPill||!intro||!overlay||!introStart||!stageBadge){
      console.error('å¿…è¦ãªDOMãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return;
    }

    /* ===== ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š ===== */
    const MAX_WORLD = 5, SUBS_PER_WORLD = 5; // 25é¢
    const TRAP_CAP_RATIO = 0.30;

    // sub: 1â†’5Ã—5, 2â†’6Ã—6, 3â†’7Ã—7, 4â†’8Ã—8, 5â†’9Ã—9
    function calcSize(world, sub){ return 4 + sub; }

    // ç½ ï¼šã‚µã‚¤ã‚ºã¨é€²è¡Œã§å¢—åŠ ï¼ˆé€šè·¯ã¯å¸¸ã«é™¤å¤–ï¼‰
    function calcTraps(world, sub, size){
      const baseBySize = {5:6, 6:9, 7:12, 8:16, 9:20};
      const base = baseBySize[size] ?? Math.floor(size*size*0.22);
      const stepWorld = 2; // ãƒ¯ãƒ¼ãƒ«ãƒ‰ãŒå¤‰ã‚ã‚‹ã¨å°‘ã—å¢—ãˆã‚‹
      const raw = base + (world-1)*stepWorld;
      const cap = Math.floor(size*size*TRAP_CAP_RATIO);
      return Math.min(cap, Math.max(4, raw));
    }

    // é€²è¡Œï¼ˆä¿å­˜ï¼‰
    let world = clamp(1, MAX_WORLD, Number(localStorage.getItem('sennyu_world')||1));
    let sub   = clamp(1, SUBS_PER_WORLD, Number(localStorage.getItem('sennyu_sub')||1));

    // çŠ¶æ…‹
    let SIZE = calcSize(world, sub);
    let board=[], revealed=[], ninjaPos=null;
    let traps = calcTraps(world, sub, SIZE);
    let castle = {x: SIZE-1, y: Math.floor(SIZE/2)};

    /* ---- ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ›ç¢ºå®Ÿå¯¾å¿œï¼‰ ---- */
    const startNow = ()=>{ intro.classList.add('hidden'); startStage(); };
    introStart.addEventListener('pointerup', startNow);
    introStart.addEventListener('click',     startNow);
    introStart.addEventListener('keydown',   e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); startNow(); } });
    intro.addEventListener('pointerup', e=>{ if(!e.target.closest('#introStart')) startNow(); });

    ovNext.addEventListener('click', ()=>{ hideOverlay(); advanceStage(); showIntro(); });
    ovRetry.addEventListener('click', ()=>{ hideOverlay(); showIntro(true); });
    retryBtn.addEventListener('click', ()=>{ hideOverlay(); showIntro(true); });
    resetBtn.addEventListener('click', ()=>{
      if(confirm('World 1-01 ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')){
        world=1; sub=1; persist(); showIntro(true);
      }
    });
    window.addEventListener('resize', ()=> setCellSize(SIZE));

    // èµ·å‹•
    showIntro();

    /* ===== åŸºæœ¬é–¢æ•° ===== */
    function persist(){
      localStorage.setItem('sennyu_world', String(world));
      localStorage.setItem('sennyu_sub',   String(sub));
    }
    function updateHud(){
      safeText(worldPill, `World ${world}-${pad2(sub)}`);
      safeText(sizePill,  `Size: ${SIZE}Ã—${SIZE}`);
      safeText(trapPill,  `ç½ : ${traps}`);
    }
    function setCellSize(size){
      const wrap = document.getElementById('boardWrap');
      const wrapW = wrap ? wrap.clientWidth : window.innerWidth;
      const innerPadding = 28;                         // board ã®å·¦å³åˆè¨ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
      const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 7;
      const usable = Math.max(160, wrapW - innerPadding - gap*(size-1) - 8);
      const px = clamp(32, 64, Math.floor(usable / size));   // æŒ‡ã§æŠ¼ã—ã‚„ã™ã„ä¸‹é™32px
      document.documentElement.style.setProperty('--cell', px + 'px');
    }

    /* ===== ãƒ«ãƒ¼ãƒˆç”Ÿæˆï¼ˆæ–œã‚ãªã—ï¼‰ ===== */
    function buildGuaranteedPath(size, castleY){
      let y = Math.floor(Math.random()*size);
      const path = new Set();
      for (let x = 0; x <= size-1; x++){
        path.add(`${x},${y}`);
        if (x < size-1){
          if (y < castleY && Math.random() < 0.5){ y++; path.add(`${x},${y}`); }
          else if (y > castleY && Math.random() < 0.5){ y--; path.add(`${x},${y}`); }
        }
      }
      while (y < castleY){ y++; path.add(`${size-1},${y}`); }
      while (y > castleY){ y--; path.add(`${size-1},${y}`); }
      return path;
    }

    function startStage(){
      SIZE = calcSize(world, sub);
      traps = calcTraps(world, sub, SIZE);
      castle = {x: SIZE-1, y: Math.floor(SIZE/2)};
      setCellSize(SIZE);
      updateHud();
      setMsg('');

      board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
      revealed = Array.from({length:SIZE},()=>Array(SIZE).fill(false));
      ninjaPos=null;

      // é€šè·¯ã‚’å…ˆã«ç¢ºå®šï¼ˆå·¦ç«¯â†’ğŸ¯ï¼‰
      const path = buildGuaranteedPath(SIZE, castle.y);
      path.add(`${castle.x},${castle.y}`);

      // ç½ é…ç½®ï¼ˆé€šè·¯ãƒ»å·¦ç«¯ãƒ»ğŸ¯ã¯é™¤å¤–ï¼‰
      let placed=0;
      while(placed<traps){
        const x=Math.floor(Math.random()*SIZE);
        const y=Math.floor(Math.random()*SIZE);
        if(x===0) continue;
        if(x===castle.x && y===castle.y) continue;
        if(path.has(`${x},${y}`)) continue;
        if(board[y][x]==='T') continue;
        board[y][x]='T'; placed++;
      }

      // æ•°å­—
      for(let y=0;y<SIZE;y++){
        for(let x=0;x<SIZE;x++){
          if(board[y][x]==='T') continue;
          board[y][x]=count8(x,y);
        }
      }

      draw();
    }

    function count8(x,y){
      let c=0;
      for(let dy=-1;dy<=1;dy++){
        for(let dx=-1;dx<=1;dx++){
          if(dx===0&&dy===0) continue;
          const nx=x+dx, ny=y+dy;
          if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) continue;
          if(board[ny][nx]==='T') c++;
        }
      }
      return c;
    }

    // å·¦ã‹ã‚‰é †ï¼šå·¦ç«¯OKã€åŒåˆ—ä¸Šä¸‹OKã€å·¦éš£OKï¼ˆæ–œã‚ä¸å¯ï¼‰
    function canOpen(x,y){
      if(revealed[y][x]) return false;
      if(x===0) return true;
      if(y>0 && revealed[y-1][x]) return true;
      if(y<SIZE-1 && revealed[y+1][x]) return true;
      if(x>0 && revealed[y][x-1]) return true;
      return false;
    }

    function draw(){
      boardEl.style.setProperty('--cols', SIZE);
      boardEl.innerHTML='';
      boardEl.classList.remove('boardShine'); document.body.classList.remove('castleGlow');

      for(let y=0;y<SIZE;y++){
        for(let x=0;x<SIZE;x++){
          const el=document.createElement('button');
          el.type='button'; el.className='cell'; el.setAttribute('role','gridcell');
          el.setAttribute('aria-label',`è¡Œ${y+1} åˆ—${x+1}`);

          const allowed = canOpen(x,y);

          if(x===0) el.classList.add('start');
          if(x===castle.x && y===castle.y) el.classList.add('castle');

          if(!revealed[y][x]){
            if(allowed) el.classList.add('frontier'); else el.classList.add('locked');
          }else{
            el.classList.add('open');
            if(board[y][x]==='T'){ el.classList.add('trap'); el.textContent='ğŸ’¥'; }
            else{
              const n=board[y][x];
              if(n===0) el.classList.add('safe0');
              else { el.textContent=n; el.classList.add('n'+n); }
            }
          }

          if (ninjaPos && ninjaPos.x===x && ninjaPos.y===y) el.classList.add('ninja');

          el.addEventListener('click', ()=>onOpen(x,y));
          el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onOpen(x,y); } });
          boardEl.appendChild(el);
        }
      }
    }

    function onOpen(x,y){
      if(!canOpen(x,y)){ setMsg('å·¦ç«¯â†’åˆ°é”æ¸ˆã¿ã®ä¸Šä¸‹å·¦å³ã ã‘é–‹ã‘ã‚‰ã‚Œã¾ã™ã€‚'); return; }
      if(revealed[y][x]) return;

      revealed[y][x]=true;
      ninjaPos={x,y};

      if(board[y][x]==='T'){
        setMsg('ğŸ’¥ ç½ ã«ã‹ã‹ã£ãŸï¼', true);
        explodeFX();
        revealAll(); draw();
        showLoseOverlay();
        return;
      }

      draw();

      // ã‚¯ãƒªã‚¢åˆ¤å®š
      if(x===castle.x && y===castle.y){
        setMsg('ğŸ‰ æ½œå…¥æˆåŠŸï¼', false, true);
        celebrateFX(); // ç´™å¹é›ª
        boardEl.classList.add('boardShine'); document.body.classList.add('castleGlow');
        revealAll(); draw();
        showWinOverlay();
      }
    }

    function setMsg(t, lose=false, win=false){
      msgEl.className=''; if(lose) msgEl.classList.add('lose'); if(win) msgEl.classList.add('win');
      safeText(msgEl, t);
    }
    function revealAll(){ for(let y=0;y<SIZE;y++) for(let x=0;x<SIZE;x++) revealed[y][x]=true; }

    function advanceStage(){
      if(sub < SUBS_PER_WORLD){ sub += 1; }
      else { sub = 1; world = Math.min(MAX_WORLD, world + 1); }
      persist();
    }

    /* ===== ã‚¤ãƒ³ãƒˆãƒ­ï¼ˆã‚»ãƒ«ã‚µã‚¤ã‚ºã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒƒã‚¸è¡¨ç¤ºï¼‰ ===== */
    function showIntro(){
      SIZE = calcSize(world, sub);
      traps = calcTraps(world, sub, SIZE);
      const label = `${world}-${pad2(sub)}`;
      safeText(stageBadge, label);
      safeText(worldPill,  `Worl
